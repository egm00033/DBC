<!DOCTYPE html>
<!-- saved from url=(0036)https://www.mql5.com/es/articles/407 -->
<html lang="es"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="description" content="Este artículo se centra en algunas capacidades de optimización que surgen cuando se tiene en cuenta el hardware subyacente en el que se ejecuta el kernel de OpenCL. Las cifras obtenidas están lejos de ser un límite pero aún así sugieren que al tener disponibles los recursos existentes aquí y ahora (la API de OpenCL como se implementó por los desarrolladores del terminal no permite el control de algunos parámetros importantes para la optimización, particularmente el tamaño del grupo) la ganancia de rendimiento sobre la ejecución del programa anfitrión es muy sustancial.">
    <meta property="og:url" content="https://www.mql5.com/es/articles/407">
    <meta property="og:title" content="OpenCL: De una programación simple a una más intuitiva">
    <meta property="og:description" content="Este artículo se centra en algunas capacidades de optimización que surgen cuando se tiene en cuenta el hardware subyacente en el que se ejecuta el kernel de OpenCL. Las cifras obtenidas están lejos de ser un límite pero aún así sugieren que al tener disponibles los recursos existentes aquí y ahora (la API de OpenCL como se implementó por los desarrolladores del terminal no permite el control de algunos parámetros importantes para la optimización, particularmente el tamaño del grupo) la ganancia de rendimiento sobre la ejecución del programa anfitrión es muy sustancial.">
    <meta property="og:image" content="https://c.mql5.com/2/0/OpenCL_Logo__1.png">
    <meta property="og:type" content="article">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@mql5com">
    <meta name="twitter:image" content="https://c.mql5.com/2/0/OpenCL_Logo__1.png">
    <meta name="format-detection" content="telephone=no">
    <link rel="shortcut icon" href="https://c.mql5.com/i/favicon.ico">
    <meta name="msapplication-config" content="none">
    <meta name="referrer" content="no-referrer-when-downgrade">

    <link href="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/core.d8955a2f50d19347101f1c4b032c4e40.css" type="text/css" rel="stylesheet" media="all">
    <link href="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/all.54e0c947aec478accc869c8a91b2b3ed.css" type="text/css" rel="stylesheet" media="all">
    <link href="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/articles.38312e686d73c939234a5810d9b2cbac.css" type="text/css" rel="stylesheet" media="all">
    
    <link href="https://www.mql5.com/es/articles/rss" rel="alternate" type="application/rss+xml" title="Artículos sobre el desarrollo y el uso de los robots comerciales e indicadores técnicos para MetaTrader 5">
    <link rel="canonical" href="https://www.mql5.com/es/articles/407">
    <link rel="alternate" hreflang="en" href="https://www.mql5.com/en/articles/407">
    <link rel="alternate" hreflang="ru" href="https://www.mql5.com/ru/articles/407">
    <link rel="alternate" hreflang="zh" href="https://www.mql5.com/zh/articles/407">
    <link rel="alternate" hreflang="es" href="https://www.mql5.com/es/articles/407">
    <link rel="alternate" hreflang="de" href="https://www.mql5.com/de/articles/407">
    <link rel="alternate" hreflang="ja" href="https://www.mql5.com/ja/articles/407">
    <link rel="alternate" hreflang="pt" href="https://www.mql5.com/pt/articles/407">
    <title>OpenCL: De una programación simple a una más intuitiva - Artículos sobre MQL5</title>
    <script async="" src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/data"></script><script async="" src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/analytics.js.descarga"></script><script src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/106067236553176" async=""></script><script async="" src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/fbevents.js.descarga"></script><script async="" defer="" type="text/javascript" src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/core.js.descarga"></script><script type="text/javascript">
        var mqGlobal = {};
        mqGlobal.AddOnLoad = function(callback)
        {
            if(!this._onload) this._onload = [];
            this._onload[this._onload.length] = callback;
            if(this.PageReady)
              callback();
        };
        mqGlobal.AddOnReady = function(callback)
        {
            if(!this._onready) this._onready = [];
            this._onready[this._onready.length] = callback;
            if(this.PageLoaded)
              callback();
        };
        mqGlobal.AddOnActiveWindowChange = function(callback)
        {
            if(!this._onvisibility) this._onvisibility = [];
            this._onvisibility[this._onvisibility.length] = callback;
        };
        mqGlobal.PageLoaded = false;
        mqGlobal.CookieDomain = ".mql5.com";
        mqGlobal.PageReady = false;
        mqGlobal.AddOnLoad(function(){mqGlobal.PageLoaded = true;});
        mqGlobal.AddOnReady(function(){mqGlobal.PageReady = true;});
        mqGlobal.Language = 'es';
        mqGlobal.IsMobile = false;
                                              
    mqGlobal.ClearRteStorage = function(frameUid)
      {
      if(!window.GStorage)
      {
        window.GStorage = globalStorage(window.globalStorageDomain,window.globalStoragePage);
      }
      if(!window.GStorage.supported)
      {
        return;
      }
      try
      {
        var frameUidLocal = frameUid;
        window.GStorage.getItem("rte_autosave_uid",function(key,value)
          {
          var storedUid = value;
          if(storedUid == frameUidLocal)
          {
            window.GStorage.removeItem("rte_autosave_text");
            window.GStorage.removeItem("rte_autosave_date");
            window.GStorage.removeItem("rte_autosave_uid");
          }
        });
      }
      catch(e)
      {
      } 
    }
</script>
    

    
    <meta property="qc:admins" content="36367170677651456375">
    <meta property="wb:webmaster" content="073d7690269bcd81">
    
    <script type="text/javascript">
      var fcoreobj = fcoreobj || {};
      fcoreobj.act = fcoreobj.act || [];
      var fcoreobjtoken = 'sqjxkxkswybhifrohpyooonwgbvsfzmayq';
      //---
      (function()
        {
         var scr, node;
         scr = document.createElement('script');
         scr.async = true;
         scr.defer = true;
         scr.type = 'text/javascript';
         scr.src =  'https://content.mql5.com/core.js';
         node = document.getElementsByTagName('script')[0];
         if(node && node.parentNode)
            node.parentNode.insertBefore(scr, node);
        })();

      fcoreobj.act.push(function()
        {
          fcoreobj.register('bfogggabsofabcpxuzmgaibarmaxasdrj');
          fcoreobj.register('krvksytflggnghiaiekrgblahesavyeohl');

          fcoreobj.finish();
    
         fcoreobj.lead(window.fcoreobjtoken);
          
        });
    </script> 
</head>

<body>
<div class="cover" id="cover">
    
    <div class="head">
        <a href="https://www.mql5.com/" class="logo" title="MQL5 - Lenguaje de estrategias comerciales para el terminal de cliente MetaTrader 5"></a>

        <ul id="mainmenu" class="menu dropdown" itemscope="" itemtype="http://schema.org/SiteNavigationElement" style="margin-right: 281px; padding-right: 0px;">
        <li class="selected">
        <a id="mainMenuSelected" href="https://www.mql5.com/es/articles/407#"><span class="on">Artículos</span><span class="off">Secciones</span></a>
         <ul id="mainmenuItems">
<li><a href="https://www.mql5.com/es/trading" itemprop="url"><span>WebTerminal</span></a></li>
<li><a href="https://www.mql5.com/es/docs" itemprop="url"><span>Documentación</span></a></li>
<li><a href="https://www.mql5.com/es/economic-calendar" itemprop="url"><span>Calendario</span></a></li>
<li><a href="https://www.mql5.com/es/code" itemprop="url"><span>CodeBase</span></a></li>
<li class="selected"><a href="https://www.mql5.com/es/articles" itemprop="url"><span>Artículos</span></a></li>
<li><a href="https://www.mql5.com/es/job" itemprop="url"><span>Freelance</span></a></li>
<li><a href="https://www.mql5.com/es/market" itemprop="url"><span>Market</span></a></li>
<li><a href="https://www.mql5.com/es/signals" itemprop="url"><span>Señales</span></a></li>
<li><a href="https://www.mql5.com/es/vps" itemprop="url"><span>VPS</span></a></li>
<li><a href="https://www.mql5.com/es/forum" itemprop="url"><span>Foro</span></a></li>
</ul>
         </li>
         <input type="checkbox" class="blurHandler"></ul>

        <div class="toolbar" id="headerToolbar">
            
            <div class="container loginRegister"><ul id="loginRegisterButtons"><li><a class="login" title="Autorícese, por favor. Se soporta la autorización OpenID" href="https://www.mql5.com/es/auth_login">Entrada</a></li><li><a class="registration es" title="Regístrese, por favor" href="https://www.mql5.com/es/auth_register">Únete &gt;&gt;</a></li></ul></div>

            <div class="groupMenu" id="groupMenu">
                
                <div class="container langMenuContainer"><div id="langMenuContainer"><b id="langMenuSelected" class="es"><span>Español</span></b><ul class="langmenu" id="langmenu"><li class="en"><a href="https://www.mql5.com/en/articles"><span>English</span></a></li><li class="ru"><a href="https://www.mql5.com/ru/articles"><span>Русский</span></a></li><li class="zh"><a href="https://www.mql5.com/zh/articles"><span>中文</span></a></li><li class="pt"><a href="https://www.mql5.com/pt/articles"><span>Português</span></a></li><li class="ja"><a href="https://www.mql5.com/ja/articles"><span>日本語</span></a></li><li class="de"><a href="https://www.mql5.com/de/articles"><span>Deutsch</span></a></li></ul></div></div>
                <div class="container searchBoxContainer"><div id="searchBoxContainer"><form action="https://www.mql5.com/es/search" onsubmit="document.location.assign((&quot;https://www.mql5.com/es/search&quot;) + ($(&quot;keyword&quot;).value.length&gt;0?(&quot;#!keyword=&quot;+encodeURIComponent($(&quot;keyword&quot;).value)):&quot;&quot;)); if(document.location.href.indexOf(&quot;/es/search#&quot;)&gt;=0)setTimeout(function(){document.location.reload(true);},10);return false;" id="main_search_form" method="post"><div class="box"><div class="inputWrapper"><input name="keyword" type="text" title="Introduzca el texto de búsqueda" id="keyword" autocomplete="off"></div></div><input type="submit" value="" class="hiddenSearchSubmit"><div class="searchSubmit" id="searchSubmit"></div></form><script type="text/javascript">mqGlobal.AddOnLoad(function(){window.keywordMainFormSuggests = new Suggestions("keyword","https://search.mql5.com/api/suggest","es",function(){$('main_search_form').onsubmit();});});</script></div></div>
            </div>
            
        </div>
    <div class="sub-nav__container" style="right: 281px; display: none;"><div class="sub-nav__toggle">...</div><ul></ul><input type="checkbox" class="blurHandler"></div></div>
    

    
        <div class="annons line download" id="annonsLine2">
          <a href="https://download.mql5.com/cdn/web/metaquotes.software.corp/mt5/mt5setup.exe?utm_campaign=MQL5.community" rel="nofollow" onclick="AnnonsLines.Close(false,2); window.fpush(&#39;Download+MT5+Windows&#39;);"><span>Descargar MetaTrader 5</span></a>
          <i onclick="AnnonsLines.Close(true, 2)" title="Cerrar"></i> 
        </div>
        
        
        <div class="top_container_f" id="bfogggabsofabcpxuzmgaibarmaxasdrj">
            <script type="text/javascript">
            fcoreobj.act.push(function()
            {
             fcoreobj.show('bfogggabsofabcpxuzmgaibarmaxasdrj');
            });
            </script>
        <a rel="noopener noreferrer" target="_blank" href="https://content.mql5.com/go?link=https%3A%2F%2Fwww.mql5.com%2Fes%2Ftrading&amp;a=alzzjbxgqusaneinlkzkzfyjopadupgn&amp;s=d71c4e0759c7b431f6f18f220aa65716&amp;v=1&amp;uid=01d2ee90f5179f38f6c7cc5e7682567&amp;back_ref=https%3A%2F%2Fwww.google.es%2F"><img width="800" height="80" src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/82f5aeef57fa812de26cce0162861d73.gif" style="overflow: hidden; vertical-align: top; height: auto;"><img width="0" height="0" src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/watch" style="display: none;"></a></div>
          
        

    <div class="body" id="bodyContent">
        <div class="top-band"></div>
<div id="left-panel" class="left-panel px200">
    <div class="treeReadWrapper">
        <ul class="treeMenuRoot"><li><a href="https://www.mql5.com/es/articles/mt5" class="codeCategory mt"><span class="inLink">MetaTrader 5</span></a><ul class="treeMenuRoot"><li class="selected"><a href="https://www.mql5.com/es/articles/mt5/examples" class="articleCategory examples"><span class="inLink">Ejemplos</span></a><ul class="treeMenuRoot nodelim"><li><a href="https://www.mql5.com/es/articles/mt5/examples_indicators" class="articleCategory examples_indicators"><span class="inLink">Indicadores</span></a></li><li><a href="https://www.mql5.com/es/articles/mt5/examples_experts" class="articleCategory examples_experts"><span class="inLink">Asesores Expertos</span></a></li></ul></li><li><a href="https://www.mql5.com/es/articles/mt5/strategy_tester" class="articleCategory strategy_tester"><span class="inLink">Probador</span></a></li><li><a href="https://www.mql5.com/es/articles/mt5/trading" class="articleCategory trading"><span class="inLink">Trading</span></a></li><li><a href="https://www.mql5.com/es/articles/mt5/trading_systems" class="articleCategory trading_systems"><span class="inLink">Sistemas comerciales</span></a></li><li><a href="https://www.mql5.com/es/articles/mt5/integration" class="articleCategory integration"><span class="inLink">Integración</span></a></li><li><a href="https://www.mql5.com/es/articles/mt5/indicators" class="articleCategory indicators"><span class="inLink">Indicadores</span></a></li><li><a href="https://www.mql5.com/es/articles/mt5/expert_advisors" class="articleCategory expert_advisors"><span class="inLink">Asesores Expertos</span></a></li><li><a href="https://www.mql5.com/es/articles/mt5/statistics" class="articleCategory statistics"><span class="inLink">Estadística y análisis</span></a></li><li><a href="https://www.mql5.com/es/articles/mt5/interviews" class="articleCategory interviews"><span class="inLink">Entrevista</span></a></li></ul></li><li><a href="https://www.mql5.com/es/articles/mt4" class="codeCategory mt"><span class="inLink">MetaTrader 4</span></a><ul class="treeMenuRoot"><li><a href="https://www.mql5.com/es/articles/mt4/examples" class="articleCategory examples"><span class="inLink">Ejemplos</span></a><ul class="treeMenuRoot nodelim"><li><a href="https://www.mql5.com/es/articles/mt4/examples_indicators" class="articleCategory examples_indicators"><span class="inLink">Indicadores</span></a></li><li><a href="https://www.mql5.com/es/articles/mt4/examples_experts" class="articleCategory examples_experts"><span class="inLink">Asesores Expertos</span></a></li></ul></li><li><a href="https://www.mql5.com/es/articles/mt4/strategy_tester" class="articleCategory strategy_tester"><span class="inLink">Probador</span></a></li><li><a href="https://www.mql5.com/es/articles/mt4/trading" class="articleCategory trading"><span class="inLink">Trading</span></a></li><li><a href="https://www.mql5.com/es/articles/mt4/trading_systems" class="articleCategory trading_systems"><span class="inLink">Sistemas comerciales</span></a></li><li><a href="https://www.mql5.com/es/articles/mt4/integration" class="articleCategory integration"><span class="inLink">Integración</span></a></li><li><a href="https://www.mql5.com/es/articles/mt4/indicators" class="articleCategory indicators"><span class="inLink">Indicadores</span></a></li><li><a href="https://www.mql5.com/es/articles/mt4/expert_advisors" class="articleCategory expert_advisors"><span class="inLink">Asesores Expertos</span></a></li><li><a href="https://www.mql5.com/es/articles/mt4/statistics" class="articleCategory statistics"><span class="inLink">Estadística y análisis</span></a></li></ul></li></ul>
    </div>
    <div style="margin-top: 28px;">
        <div class="newmenu-advice">
            <div class="suggestIco affiliateArticle"></div>
            <p>¿Le ha gustado el artículo?<br>
            Ponga el <a href="https://www.mql5.com/es/articles/407" target="_blank">enlace</a> al artículo -<br>que los demás también lo lean</p>
        </div>
        <div class="newmenu-advice">
            <div class="suggestIco mt5"></div>
            <p>Utilice nuevas posibilidades de <a href="https://download.mql5.com/cdn/web/metaquotes.software.corp/mt5/mt5setup.exe?utm_campaign=MQL5.community" rel="nofollow">MetaTrader 5</a></p>
        </div>
        <div>
            
        </div>
        
    </div><div id="krvksytflggnghiaiekrgblahesavyeohl" class="articles__f"><script type="text/javascript">fcoreobj.act.push(function () {fcoreobj.show('krvksytflggnghiaiekrgblahesavyeohl');});</script></div>
</div>


<div class="articles-content px200 splashed">
<div itemscope="" itemtype="http://schema.org/TechArticle">
    <div class="article-tools">
        <div>
            <span class="popup framed client flags">
                <a class="dropdown es" href="javascript:void(false);"><span></span><i></i></a>
                <span class="popup">
                    <span class="tip"><span></span></span>
                    <span class="items">
                        <a href="https://www.mql5.com/en/articles/407">English</a> <a href="https://www.mql5.com/ru/articles/407">Русский</a> <a href="https://www.mql5.com/zh/articles/407">中文</a> <a href="https://www.mql5.com/de/articles/407">Deutsch</a> <a href="https://www.mql5.com/ja/articles/407">日本語</a> <a href="https://www.mql5.com/pt/articles/407">Português</a>
                    </span>
                </span>
            </span>
        </div>
        
        <div><span class="share shareWrapperIconed"><a class="share midIco" id="share_2_1_407" onclick="shareManager.OpenShareEditor(this,&#39;Compartir con sus amigos en las redes sociales&#39;,&#39;/es/share/2/1/407&#39;,false);return false;" title="Compartir en las redes sociales" href="javascript:void(0);"></a></span></div>
        <div><a href="https://www.mql5.com/es/articles/407?print=" target="_blank" class="print" rel="nofollow" title="Versión para imprimir"></a></div>
    </div> 
    <div class="article-head">
        <div class="splash"><div></div></div>
        <div class="caption">
            <div class="category" itemprop="articleSection">
                <a href="https://www.mql5.com/es/articles/mt5">MetaTrader 5</a>
                —
                <a href="https://www.mql5.com/es/articles/mt5/examples">Ejemplos</a>
            </div>

           <h1 itemprop="name">OpenCL: De una programación simple a una más intuitiva</h1>
            <div class="date">14 marzo 2014, 09:59</div>
            <meta itemprop="datePublished" content="2014-03-14">
        </div>
        <div class="avatar">
            <img itemprop="image" src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/54190607-0000.jpg" title="Sceptic Philozoff" alt="Sceptic Philozoff" width="60" height="60">
        </div>
        <div class="author" itemtype="http://schema.org/Person" itemprop="author" itemscope="itemscope">
          <a class="author" title="Sceptic Philozoff (Mathemat)" href="https://www.mql5.com/es/users/mathemat">Sceptic Philozoff</a>
          <meta itemprop="name" content="Sceptic Philozoff">
          <meta itemprop="url" content="https://www.mql5.com/es/users/Mathemat">
        </div>
        <div class="counters">
          <div class="commentsCounter" title="Comentarios">0<i class="icon comments"></i></div>
          <div class="viewsCounter" title="Visitas"><i class="icon views"></i>1 660</div>
        </div>
    </div>
     
<div class="content" itemprop="articleBody">
<div class="inner" itemprop="text">
  <br>
<h3>Introducción<br></h3>
<p>El primer artículo <a target="_blank" href="https://www.mql5.com/es/articles/405">"OpenCL: El puente hacia mundos paralelos"</a> fue una introducción del tema de OpenCL. En él se trataron los aspectos básicos de la interacción entre el programa OpenCL (también llamado kernel aunque no es muy correcto) y el programa externo (anfitrión) en MQL5. Algunas capacidades de funcionamiento del lenguaje (p.ej. el uso de tipos de datos vector) fueron ilustrados por el cálculo de pi = 3.14159265... <br></p>

<p>La optimización del funcionamiento del programa fue en algunos casos considerable. Sin embargo, todas estas optimizaciones eran ingenuas ya que no tenían en cuenta las especificaciones del hardware utilizado para realizar todos nuestros cálculos. El conocimiento de estas especificaciones puede, en la mayoría de casos, permitirnos conseguir mejoras de velocidad que van más allá de las capacidades de la CPU.<br></p>

<p>Para demostrar estas optimizaciones, el autor tuvo que recurrir a un ejemplo nada original que es probablemente uno de los más estudiados en la literatura sobre OpenCL. Es la multiplicación de dos grandes matrices. <br></p>

<p>Vamos a empezar con los principal: el modelo de memoria de OpenCL junto con peculiaridades de su implementación en la arquitectura de hardware ideal.</p>

<h3><br>1. Jerarquía de memoria en dispositivos de computación modernos<br></h3>
<p><b>1.1. El modelo de memoria de OpenCL</b><br></p>

<p>En general, los sistemas de memoria se diferencian bastante entre sí dependiendo de las plataformas. Por ejemplo, todas las CPU modernas soportan la recogida de datos automática, al contrario de las GPU donde este no es siempre el caso.<br></p>

<p>Para garantizar la portabilidad del código, se ha adoptado un modelo de memoria abstracto en OpenCL que los programadores y distribuidores que necesitan implementarlo en el hardware real pueden adoptar. La memoria, como se define en OpenCL puede ilustrarse teóricamente como en la Figura siguiente:</p>

<p style="text-align:center;"><img alt="El modelo de memoria de OpenCL" title="El modelo de memoria de OpenCL" src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/memory_model.PNG" height="513" width="608" style="vertical-align:middle;"></p>

<p style="text-align:center;"><span class="small">Fig. 1. El modelo de memoria de OpenCL</span><br></p>

<p>Una vez que los datos son transferidos desde el anfitrión al dispositivo, se almacenan en el dispositivo de memoria global. Cualquier dato transferido en dirección opuesta también se almacena en la memoria global (pero esta vez en la memoria global del anfitrión). La palabra clave _global (¡dos caracteres subrayados!) es un modificador que indica que los datos asociados con un cierto puntero se almacenan en la memoria global:&nbsp; <br></p>

<pre class="code">__kernel <span class="keyword">void</span> foo( __global <span class="keyword">float</span> *A ) { <span class="comment">/// kernel code }</span></pre><div class="atten"><p><i></i> La <i>memoria global</i> es accesible para todas las unidades de cómputo dentro del dispositivo como la RAM en el sistema anfitrión. <br></p></div>

<p>La memoria constante, al contrario de lo que indica su nombre, no almacena datos de solo lectura necesariamente. Este tipo de memoria está diseñada para datos en los que se puede acceder a cada elemento simultáneamente por parte de todas las <i>unidades de trabajo</i>. Las variables con valores constantes por supuesto caen dentro de esta categoría también. La memoria constante en el modelo OpenCL es una parte de la memoria global y los objetos de la memoria transferidos a la memoria global pueden especificarse como __constant.<br></p>

<p>La memoria local es memoria auxiliar donde el espacio de la dirección es único para cada dispositivo. En el hardware, a menudo viene en la forma de memoria sobre chip pero no hay ningún requisito especial para que sea exactamente el mismo para OpenCL. </p>

<div class="atten">La <i>memoria local</i> es accesible por todo el grupo de trabajo, es decir, se comparte entre todas las unidades dentro del grupo y no es accesible por otros grupos. <br></div>

<p>El acceso a este tipo de memoria implica un menor tiempo de espera y el ancho de banda es por tanto mucho mayor que el de la memoria global. Intentaremos aprovechar su menor tiempo de respuesta para la optimización del rendimiento del kernel.<br></p>
<p>La especificación de OpenCL dice que un variable en la memoria local puede declararse en el encabezado del kernel:<br></p>

<pre class="code">__kernel <span class="keyword">void</span> foo( __local <span class="keyword">float</span> *sharedData ) { }</pre>y en su cuerpo:<br><pre class="code">__kernel <span class="keyword">void</span> foo( __global <span class="keyword">float</span> *A )
{
&nbsp;&nbsp; __local <span class="keyword">float</span> sharedData[ <span class="number">64</span> ];&nbsp;&nbsp; 
}</pre>Tenga en cuenta que una matriz dinámica no puede declararse en el cuerpo del kernel, siempre debemos especificar su tamaño.<br>

<p><br>Más abajo, en la optimización del kernel para la multiplicación de dos matrices grandes, veremos cómo gestionar los datos locales y qué peculiaridades de implementación implica en Meta Trader 5 según la experiencia del autor.</p>

<div class="atten"><i></i>La <i>memoria privada</i> es única para cada unidad de trabajo. Solo es accesible por esa unidad y no se comparte entre otras unidades de trabajo.<br></div>


<p>Las variables locales y los argumentos del kernel que no contienen punteros son privados por defecto (si se especifican sin el modificador __local). En la práctica, estas variables se encuentran normalmente en los registros. Y viceversa, las matrices privadas y <a href="https://www.mql5.com/go?http://en.wikipedia.org/wiki/Register_pressure" title="http://en.wikipedia.org/wiki/Register_pressure" target="_blank">cualquier registro vertido</a> están siempre en una memoria fuera de chip, es decir, una memoria de mayor tiempo de espera. Permítanme citar la información relevante de la Wikipedia:</p>

<div class="fquote"><p>En muchos lenguajes de programación, el programador tiene la ilusión de asignar arbitrariamente muchas variables. Sin embargo, durante la compilación, el compilador debe decidir cómo asignar estas variables a un conjunto de registros pequeño y finito. No todas las variables se encuentran en uso (o "vivas") al mismo tiempo, por lo que algunos registros pueden ser asignados a más de una variable. Sin embargo, dos variables en uso al mismo tiempo no pueden ser asignadas al mismo registro sin alterar su valor.  <br></p>

<p>Las variables que no pueden asignarse a algunos registros deben mantenerse en la RAM y cargadas/descargadas para cada lectura/escritura, un proceso llamado volcado. El acceso a la RAM es mucho más lento que el acceso a los registros y ralentiza la velocidad de ejecución del programa compilado, por lo que un compilador optimizador intentará asignar tantas variables a los registros como sea posible. La presión del registro es el término usado cuando hay menos registros de hardware disponibles de lo que sería óptimo. Una mayor presión significa que son necesarios más volcados y recargas.</p></div>La presión del registro es la realidad de la programación para GPU ya que debido a un mayor número de núcleos en un área de chip limitada es imposible tener muchos registros.<br>

<p><br>El modelo de memoria de OpenCL que se ha descrito es muy similar a la estructura de memoria de las modernas GPU. La figura a continuación muestra una correlación entre el modelo de memoria de OpenCL y el modelo de memoria de GPU AMD Radeon HD 6970.<br></p>

<p style="text-align:center;"><img alt="Fig. 2. Correlación entre la estructura de memoria de la Radeon HD 6970 y el modelo de memoria abstracto de OpenCL" title="Fig. 2. Correlación entre la estructura de memoria de la Radeon HD 6970 y el modelo de memoria abstracto de OpenCL" src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/Radeon_HD_6970_memory.png" height="402" width="747" style="vertical-align:middle;"><br></p>

<p style="text-align:center;"><span class="small">Fig. 2. Correlación entre la estructura de memoria de la Radeon HD 6970 y el modelo de memoria abstracto de OpenCL</span><br></p><p>Vamos a considerar en mayor detalle los aspectos relacionados con una implementación específica de memoria GPU.</p><p><br></p>
<p><b>1.2. La memoria en las GPU discretas modernas</b><br></p>

<p><i><b>1.2.1. Solicitudes de memoria combinadas</b></i></p>

<p>Esta información es también importante para la optimización del funcionamiento del kernel ya que el objetivo principal es lograr un ancho de banda de memoria alto.</p><p> Vamos a ver la figura a continuación para entender mejor el proceso de direccionamiento de la memoria:</p>

<p style="text-align:center;"><span class="small"><img alt="Fig. 3. Esquema de direccionamiento de datos en la memoria de dispositivo global" title="Fig. 3. Esquema de direccionamiento de datos en la memoria de dispositivo global" src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/array_pointer__2.PNG" height="361" width="721" style="vertical-align:middle;"><br></span></p>

<p style="text-align:center;"><span class="small">Fig. 3. Esquema de direccionamiento de datos en la memoria de dispositivo global</span></p>
<p>Supongamos que el puntero a una matriz de variables enteras int es la dirección de X = 0x00001232. Cada int toma 4 bytes de memoria. Suponemos que un hilo (que es un software análogo a una unidad de trabajo que ejecuta el código del kernel) direcciona los datos en Х[ 0 ]: <br></p>

<pre class="code"><span class="keyword">int</span> tmp = X[ <span class="number">0</span> ];</pre>

<p>Asumimos que el ancho del bus de memoria es de 32 bytes (256 bits). Este ancho de bus es típico de las potentes GPU, como la Radeon HD 5870. En algunas otras GPU, el ancho del bus de datos puede ser diferente, p. ej. 384 bits o incluso 512 en algunos modelos de NVidia.<br></p>

<p>El direccionamiento del bus de memoria debe corresponderse con su estructura, es decir, lo primero de todo es el ancho. En otras palabras, los datos en la memoria se almacenan en bloques de 32 bytes (256 bits) cada uno. Con independencia de lo que direccionemos en el rango entre 0x00001220 y 0x0000123F (hay exactamente 32 bytes en este rango, podemos comprobarlo nosotros mismos), obtendremos la dirección 0x00001220 como dirección de inicio para la lectura. <br></p>

<p>El acceso a la dirección 0x00001232 devolverá todos los datos en las direcciones dentro del rango desde 0x00001220 to 0x0000123F, es decir, 8 números enteros. Por tanto, solo habrá 4 bytes (un número entero) de datos útiles mientras que los restantes 28 bytes (7 números enteros) serán inútiles:<br></p>

<p style="text-align:center;"><img alt="" title="" src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/1_int_from_8_only.PNG" height="222" width="584" style="vertical-align:middle;"></p>

<p style="text-align:center;"><span class="small">Fig. 4. Esquema de la obtención de los datos requeridos de la memoria</span><br></p><p>El número que necesitamos localizar en la dirección especificada anteriormente - 0x00001232 - está dentro de un círculo en el esquema. <br></p>

<p>Para maximizar el uso del bus, la GPU intenta combinar los accesos a la memoria de diferentes hilos en una única solicitud de memoria, cuantos menos accesos a la memoria mejor. La razón detrás de esto es que el acceso a la memoria del dispositivo global nos cuesta tiempo y por ello afecta enormemente a la velocidad de ejecución del programa. Consideremos la siguiente línea del código kernel:<br></p>

<pre class="code"><span class="keyword">int</span> tmp = X[ get_global_id( <span class="number">0</span> ) ]; </pre>

<p>Supongamos que nuestra matriz X es la matriz del ejemplo anterior. Los primeros 16 hilos (kernels) accederán a direcciones entre 0x00001232 y 0x00001272 (hay 16 números enteros dentro de este rango, es decir, 64 bytes). Si cada solicitud fue enviada por los kernels independientemente, sin haber sido previamente combinada en una sola, cada una de las 16 solicitudes contendrían 4 bytes de datos útiles y 28 bytes de datos inútiles, haciendo un total de 64 bytes usados y 448 no usados. <br></p>

<p>Este cálculo se basa en el hecho de que cada acceso a una dirección situada dentro del mismo bloque de memoria de 32 bytes devolverá idénticos datos. Este es el clave. Sería más correcto combinar múltiples solicitudes en una sola, para que las solicitudes coherentes economizarán el uso de las inútiles. Esta operación será llamada aquí combinación y las solicitudes combinadas como tales serán denominadas como coherentes.</p><p><br></p>

<p style="text-align:center;"><img alt="" title="" src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/3_accesses.PNG" height="194" width="440" style="vertical-align:middle;"></p><p style="text-align:center;"><span class="small">Fig. 5. Solo son necesarias tres solicitudes de memoria para obtener los datos necesarios</span><br></p>

<p>Cada celda en la Figura anterior es de 4 bytes. En nuestro ejemplo, son suficientes 3 solicitudes. Si el comienzo de la matriz estaba alineada con la dirección del principio de cada bloque de memoria de 32 bytes, incluso 2 solicitudes serían suficientes.<br></p>

<p>En una GPA AMD 64, los hilos son parte de un frente de ola y deben ejecutar la misma instrucción que en la ejecución de SIMD. 16 hilos organizados por get_global_id( 0 ), siendo exactamente un cuarto del frente de ola, se combinan en una solicitud coherente para un uso eficiente del bus. <br></p>

<p>A continuación se muestra una ilustración del ancho de banda de memoria necesario para las solicitudes incoherentes comparados con las incoherentes, es decir, las solicitudes "espontáneas". Se refiere a la Radeon HD 5870. Puede observarse un resultado similar en las tarjetas NVidia.<br><br></p><p style="text-align:center;"><img alt="" title="" src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/coalescenced-uncoalescenced-BW.PNG" height="294" width="635" style="vertical-align:middle;"></p>

<p style="text-align:center;"><span class="small">Fig. 6. Análisis comparativo del ancho de banda de memoria requerido para las solicitudes coherentes e incoherentes</span><br></p>

<p>Puede verse claramente que una solicitud de memoria coherente permite incrementar el ancho de banda de memoria por casi un orden de magnitud.<br></p>
<br><p><i><b>1.2.2. Bancos de memoria</b></i></p>

<p>La memoria está compuesta de bancos donde los datos se almacenan. En las modernas GPU, estos son normalmente palabras de 32 bits (4 bytes). Los datos en serie se almacenan en bancos de memoria adyacentes. Un grupo de hilos accediendo a elementos en serie no producirá ningún conflicto en los bancos.<br></p><p>El efecto negativo máximo de los conflictos de bancos se observa normalmente en la memoria GPU local. Es por tanto aconsejable que los accesos a datos locales desde hilos próximos se dirijan a bancos de memoria distintos.<br></p>

<p>En el hardware de AMD, el frente de onda que genera conflictos de bancos se atasca hasta que se completan las operaciones de la memoria local. Esto genera una <i>serialización</i> donde los bloques de código que deben ejecutarse en paralelo se ejecutan secuencialmente. Tiene un efecto extremadamente negativo en el rendimiento del kernel.<br><br></p>

<p style="text-align:center;"><img alt="" title="" src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/no_conflicts_local.PNG" height="285" width="637" style="vertical-align:middle;"></p>

<p style="text-align:center;"><span class="small">Fig. 7. Esquemas de acceso a memoria sin conflictos de banco</span><br></p>

<p>La figura anterior muestra el acceso a memoria sin conflictos de banco ya que todos los hilos acceden a distintos datos. <br></p><p>Vamos a ilustrar el acceso a memoria con conflictos de banco:</p><br><p style="text-align:center;"><img alt="" title="" src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/conflicts_local.PNG" height="286" width="328" style="vertical-align:middle;"></p>

<p style="text-align:center;"><span class="small">Fig. 8. Acceso a memoria con conflictos de banco</span><br></p>

<p>La situación sin embargo tiene una excepción: si todos los accesos son a la misma dirección, el banco puede realizar una <i>publicación</i> para evitar el retraso:<br><br></p>

<p style="text-align:center;"><img alt="" title="" src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/broadcast.PNG" height="280" width="271" style="vertical-align:middle;"></p><p style="text-align:center;"><span class="small">Fig. 9. Todos los hilos acceden a la misma dirección</span><br></p>

<p>Ocurrirán eventos similares cuando se accede a la memoria global pero el impacto de estos conflictos es considerablemente menor.<br><br></p>

<i><b>1.2.3. Memoria de la GPU : Conclusiones </b></i><br>
<ul>
<li>La memoria de la GPU es distinta de la de la CPU. El principal objetivo a la hora de optimizar el funcionamiento del programa usando OpenCL es garantizar el máximo ancho de banda en lugar de reducir el tiempo de espera, como ocurriría en la CPU.</li>
<li>La naturaleza del acceso a memoria tiene un gran impacto en la eficiencia del uso del bus. Una eficiencia en el uso del bus baja significa una velocidad de ejecución baja.</li>
<li>Para mejorar el funcionamiento del código, es aconsejable que el acceso a memoria sea coherente. Además, es mucho mejor para evitar conflictos de banco.</li>
<li>Las especificaciones del hardware (ancho del bus, el número de bancos de memoria, así como el número de hilos que pueden combinarse para un único acceso coherente) puede encontrarse en la documentación del proveedor.</li>
</ul>
<br>
<p>Las especificaciones de algunas tarjetas gráficas Radeon de las series 5xxx se muestran a continuación como ejemplo:<br><br></p>

<p style="text-align:center;"><img alt="" title="" src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/58xx_table.PNG" height="874" width="625" style="vertical-align:middle;"></p>

<p style="text-align:center;"><span class="small">Fig. 10. Especificaciones técnicas de tarjetas gráficas Radeon HD 58xx de gama media y alta <br></span></p>
<p>Vamos ahora a ver la programación.<br><br>
</p><h3>2. Multiplicación de matrices cuadradas grandes: Del código de CPU en serie al código de GPU en paralelo <br></h3>
<p><b>2.1. Código de MQL5</b><br></p>

<p>La tarea por delante, al contrario que el artículo anterior <a target="_blank" href="https://www.mql5.com/es/articles/405">"OpenCL: el puente hacia mundos paralelos"</a>, es estándar, es decir, multiplicar dos matrices. Se ha elegido principalmente debido al hecho de que una gran parte de la información al respecto se encuentra disponible en diferentes fuentes. La mayoría de ellas, de una u otra forma, ofrecen soluciones más o menos coordinadas. Este es el camino que vamos a recorrer, dando aclaraciones paso a paso sobre el significado de las estructuras del modelo mientras tenemos en mente que estamos trabajando con hardware real.</p>
<p>A continuación se muestra un fórmula de multiplicación de matrices conocida en el álgebra lineal, modificada para los cálculos por ordenador. El primer índice es el número de la fila de la matriz y el segundo el número de la columna. Cada elemento de la matriz obtenida se calcula añadiendo cada uno de los sucesivos productos de los elementos en la primera y la segunda matriz a la suma acumulada. Al final, esta suma acumulada es el elemento de la matriz obtenida calculado:<br></p>

<p style="text-align:center;"><img alt="" title="" src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/matrix_mul_formula.PNG" height="177" width="333" style="vertical-align:middle;"></p><p style="text-align:center;"><span class="small">Fig. 11. Fórmula de multiplicación de la matriz</span><br></p>

<p>Puede representarse esquemáticamente de esta forma:</p>



<p style="text-align:center;"><img alt="Fig. 12. Algoritmo de multiplicación de matrices (ilustrado mediante el cálculo de un elemento de la matriz obtenida) representado algorítmicamente" title="Fig. 12. Algoritmo de multiplicación de matrices (ilustrado mediante el cálculo de un elemento de la matriz obtenida) representado algorítmicamente" src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/mul_picture__2.PNG" height="176" width="746" style="vertical-align:middle;"><br></p>

<p style="text-align:center;"><span class="small">Fig. 12. Algoritmo de multiplicación de matrices (ilustrado mediante el cálculo de un elemento de la matriz obtenida) representado algorítmicamente</span></p>

<p>Puede verse fácilmente que donde ambas matrices tienen las mismas dimensiones iguales a N, el número de adiciones y multiplicaciones puede estimarse por la función O(N^3): para calcular cada elemento de la matriz obtenida, necesitamos obtener el producto escalar e una fila en la primera matriz y una columna en la segunda matriz. Requiere cerca de 2*N adiciones y multiplicaciones. El cálculo necesario se obtiene multiplicando por el número de elementos de la matriz N^2. De esta forma, el tiempo de ejecución del código aproximado depende considerablemente de N al cubo. <br></p>

<p>El número de filas y columnas para las matrices se establece en 2.000 solo por comodidad, puede ser arbitrario pero no demasiado grande.<br><br>El código en MQL5 no es muy complejo:</p><pre class="code"><span class="comment">//+------------------------------------------------------------------+</span>
<span class="comment">//|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_2dim.mq5 |</span>
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="preprocessor">#define ROWS1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="number">1000</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// rows in the first matrix</span></span>
<span class="preprocessor">#define COLSROWS&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="number">1000</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// columns in the first matrix = rows in the second matrix </span></span>
<span class="preprocessor">#define COLS2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="number">1000</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// columns in the second matrix</span></span>

<span class="keyword">float</span> first[ ROWS1&nbsp;&nbsp;][ COLSROWS ];&nbsp;&nbsp;<span class="comment">// first matrix</span>
<span class="keyword">float</span> second[ COLSROWS ][ COLS2 ];&nbsp;&nbsp;<span class="comment">// second matrix</span>
<span class="keyword">float</span> third[ ROWS1 ][ COLS2 ];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// product</span>
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="comment">//| Script program start function&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</span>
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="keyword">void</span> <span class="functions">OnStart</span>()
&nbsp;&nbsp;{
&nbsp;&nbsp; <span class="functions">MathSrand</span>(<span class="functions">GetTickCount</span>());

&nbsp;&nbsp; <span class="functions">Print</span>(<span class="string">"======================================="</span>);
&nbsp;&nbsp; <span class="functions">Print</span>(<span class="string">"ROWS1 = "</span>+i2s(ROWS1)+<span class="string">"; COLSROWS = "</span>+i2s(COLSROWS)+<span class="string">"; COLS2 = "</span>+i2s(COLS2));

&nbsp;&nbsp; genMatrices();
&nbsp;&nbsp; <span class="functions">ArrayInitialize</span>(third,<span class="number">0.0</span>f);

<span class="comment">//--- execution on the CPU</span>
&nbsp;&nbsp; <span class="keyword">uint</span> st1=<span class="functions">GetTickCount</span>();
&nbsp;&nbsp; mul();
&nbsp;&nbsp; <span class="keyword">double</span> time1=(<span class="keyword">double</span>)(<span class="functions">GetTickCount</span>()-st1)/<span class="number">1000</span>.;
&nbsp;&nbsp; <span class="functions">Print</span>(<span class="string">"CPU: time = "</span>+<span class="functions">DoubleToString</span>(time1,<span class="number">3</span>)+<span class="string">" s."</span>);

&nbsp;&nbsp; <span class="keyword">return</span>;
&nbsp;&nbsp;}
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="comment">//| i2s&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</span>
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="keyword">string</span> i2s(<span class="keyword">int</span> arg) { <span class="keyword">return</span> <span class="functions">IntegerToString</span>(arg); }
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="comment">//| genMatrices&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</span>
<span class="comment">//| generate initial matrices; this generation is not reflected&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span>
<span class="comment">//| in the final runtime calculation&nbsp;              &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span>
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="keyword">void</span> genMatrices()
&nbsp;&nbsp;{
&nbsp;&nbsp; <span class="keyword">for</span>(<span class="keyword">int</span> r=<span class="number">0</span>; r&lt;ROWS1; r++)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>(<span class="keyword">int</span> c=<span class="number">0</span>; c&lt;COLSROWS; c++)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; first[r][c]=genVal();

&nbsp;&nbsp; <span class="keyword">for</span>(<span class="keyword">int</span> r=<span class="number">0</span>; r&lt;COLSROWS; r++)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>(<span class="keyword">int</span> c=<span class="number">0</span>; c&lt;COLS2; c++)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; second[r][c]=genVal();

&nbsp;&nbsp; <span class="keyword">return</span>;
&nbsp;&nbsp;}
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="comment">//| genVal&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span>
<span class="comment">//| generate one value of the matrix element:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; |</span>
<span class="comment">//| uniformly distributed value lying in the range [-0.5; 0.5]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span>
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="keyword">float</span> genVal()
&nbsp;&nbsp;{
&nbsp;&nbsp; <span class="keyword">return</span>(<span class="keyword">float</span>)(( <span class="functions">MathRand</span>()-<span class="number">16383.5</span>)/<span class="number">32767</span>.);
&nbsp;&nbsp;}
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="comment">//| mul&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</span>
<span class="comment">//| Main matrix multiplication function&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span>
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="keyword">void</span> mul()
&nbsp;&nbsp;{
<span class="comment">// r-cr-c: 10.530 s </span>
&nbsp;&nbsp; <span class="keyword">for</span>(<span class="keyword">int</span> r=<span class="number">0</span>; r&lt;ROWS1; r++)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>(<span class="keyword">int</span> cr=<span class="number">0</span>; cr&lt;COLSROWS; cr++)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="keyword">for</span>(<span class="keyword">int</span> c=<span class="number">0</span>; c&lt;COLS2; c++)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;third[r][c]+=first[r][cr]*second[cr][c];
<span class="comment"></span>
&nbsp;&nbsp; <span class="keyword">return</span>;
&nbsp;&nbsp;}<span class="comment"></span>
</pre><p style="text-align:center;"><span class="small">Listado 1. Programa secuencial inicial en el anfitrión</span></p><p>Resultados utilizando distintos parámetros:</p><pre class="code"><span class="number">2012.05</span>.<span class="number">19</span> <span class="number">09</span>:<span class="number">39</span>:<span class="number">11</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_2dim (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPU: time = <span class="number">10.530</span> s.
<span class="number">2012.05</span>.<span class="number">19</span> <span class="number">09</span>:<span class="number">39</span>:<span class="number">00</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_2dim (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;ROWS1 = <span class="number">1000</span>; COLSROWS = <span class="number">1000</span>; COLS2 = <span class="number">1000</span>
<span class="number">2012.05</span>.<span class="number">19</span> <span class="number">09</span>:<span class="number">39</span>:<span class="number">00</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_2dim (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;=======================================

<span class="number">2012.05</span>.<span class="number">19</span> <span class="number">09</span>:<span class="number">41</span>:<span class="number">04</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_2dim (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPU: time = <span class="number">83.663</span> s.
<span class="number">2012.05</span>.<span class="number">19</span> <span class="number">09</span>:<span class="number">39</span>:<span class="number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_2dim (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;ROWS1 = <span class="number">2000</span>; COLSROWS = <span class="number">2000</span>; COLS2 = <span class="number">2000</span>
<span class="number">2012.05</span>.<span class="number">19</span> <span class="number">09</span>:<span class="number">39</span>:<span class="number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_2dim (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;=======================================</pre>

<p><br>Como puede verse, nuestra dependencia estimada del tiempo de ejecución en los tamaños de la matriz lineal parece haber sido cierta: se ha obtenido un incremento del doble en todas las dimensiones de la matriz en una incremento del tiempo de ejecución de casi 8 veces.<br></p>

<p>Algunas palabras sobre el algoritmo: el orden del lazo puede cambiarse arbitrariamente en la función de multiplicación mul(). Resulta que tiene un efecto considerable en el tiempo de ejecución: el ratio del tiempo de ejecución más lento sobre el más rápido es de casi 1,73. <br></p>

<p>El artículo solo muestra la variante más rápida. Las variantes probadas restantes pueden encontrarse en el código adjunto al final del artículo (archivo matr_mul_2dim.mq5). En este sentido, la guía de programación de OpenCL   (Aaftab Munshi, Benedict R. Gaster, Timothy G. Mattson, James Fung, Dan Ginsburg) dice lo siguiente (p. 512):</p>

<div class="fquote">[Estas permutaciones] sirven para cambiar los patrones de acceso a memoria y reutilizar así los datos de la caché ya que el contenido de las tres matrices se realiza a través de la CPU.<br></div><p>Estas no son obviamente todas las optimizaciones del código "no paralelo" inicial que podemos implementar. Algunas de ellas están relacionadas con el hardware (instrucciones (S)SSEx) mientras otras son puramente algorítmicas, p. ej. <a href="https://www.mql5.com/go?http://ru.wikipedia.org/wiki/%D0%90%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC_%D0%A8%D1%82%D1%80%D0%B0%D1%81%D1%81%D0%B5%D0%BD%D0%B0" title="http://ru.wikipedia.org/wiki/Алгоритм_Штрассена" target="_blank">el algoritmo Strassen</a>, <a href="https://www.mql5.com/go?http://ru.wikipedia.org/wiki/%D0%90%D0%BB%D0%B3%D0%BE%D1%80%D0%B8%D1%82%D0%BC_%D0%9A%D0%BE%D0%BF%D0%BF%D0%B5%D1%80%D1%81%D0%BC%D0%B8%D1%82%D0%B0_%E2%80%94_%D0%92%D0%B8%D0%BD%D0%BE%D0%B3%D1%80%D0%B0%D0%B4%D0%B0" title="http://ru.wikipedia.org/wiki/Алгоритм_Копперсмита_—_Винограда" target="_blank">el algoritmo Coppersmith–Winograd</a>, etc. Tenga en cuenta que el tamaño de las matrices multiplicadas para el algoritmo Strassen que provoquen un aumento de la velocidad considerable con relación al algoritmo clásico es muy pequeño, solo de 64x64. En este artículo vamos a aprender a multiplicar rápidamente matrices cuyo tamaño lineal es de hasta varios millares (aproximadamente hasta 5.000).</p>

<br>

<p><b>2.2. La primera implementación del algoritmo en OpenCL</b><br></p>

<p>Vamos ahora a exportar este algoritmo a OpenCL, creando ROWS1*COLS2 hilos, es decir, borrando ambos lazos exteriores del kernel. Cada hilo ejecutará COLSROWS iteraciones por lo que el lazo interior sigue siendo parte del kernel.<br></p>

<p>Como tendremos que crear tres buffers lineales para el kernel de OpenCL sería razonable volver a recomponer el algoritmo inicial para que sea tan parecido al algoritmo del kernel como sea posible. El código del programa "no paralelo" en una "CPU de un solo núcleo" con buffers lineales será proporcionado junto con el código del kernel. Que el código sea óptimo con matrices de dos dimensiones no significa que su análogo sea también óptimo para los buffers lineales: todas las pruebas deberán repetirse. Por tanto, de nuevo optamos por c-r-cr como la variante inicial que corresponde a la lógica estándar de la multiplicación de matrices en el álgebra lineal.<br></p>

<p>Dicho esto, para evitar en lo posible la confusión en el direccionamiento de los elementos de la matriz/buffer, responda a la siguiente pregunta: si tenemos una matriz Matr (M filas y N columnas) en una memoria GPU global como buffer lineal, ¿cómo podemos calcular el cambio lineal de un elemento Matr[ fila ][ columna ]?<br></p>

<p>De hecho no hay orden fijo para disponer una matriz en la memoria de la GPU ya que está determinado por la lógica del propio problema. Por ejemplo, los elementos de ambas matrices pueden disponerse de forma distinta en los buffers ya que en lo que respecta al algoritmo de multiplicación de la matriz, las matrices son asimétricas, es decir, las filas de la primera matriz se multiplican por las columnas de la segunda matriz. Esta nueva disposición puede afectar en gran medida el rendimiento del cálculo en la lectura secuencial de los elementos de la matriz de la memoria de la GPU global en cada iteración del kernel. <br></p>

<p>La primera implementación del algoritmo tendrá matrices dispuestas de la misma forma, en orden según la fila mayor. Los primeros elementos de la fila serán los primeros en situarse en el buffer seguidos por todos los elementos de la segunda fila, y así sucesivamente. La fórmula de nivelar una representación de dos dimensiones de una matriz Matr[ M (filas) ][ N (columnas) ] en una memoria lineal es de la siguiente forma:</p>

<div class="code">Matr[ fila ][ columna ] = buff[ fila * N (Total_columnas) + columna ]<br></div><p><br></p>

<p style="text-align:center;"><img alt="Fig. 13. Algoritmo para convertir un espacio de índice de dos dimensiones en lineal para disponer la matriz en el buffer de la GPU." title="Fig. 13. Algoritmo para convertir un espacio de índice de dos dimensiones en lineal para disponer la matriz en el buffer de la GPU." src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/matrix2buff__3.GIF" height="305" width="737" style="vertical-align:middle;"><br></p>

<p style="text-align:center;"><span class="small">Fig. 13. Algoritmo para convertir un espacio de índice de dos dimensiones en lineal para disponer la matriz en el buffer de la GPU.</span><br></p>
<p>La figura anterior es un ejemplo de cómo se nivela una representación de una matriz de dos dimensiones en una memoria lineal en orden según la columna mayor.<br><br>A continuación se muestra un código ligeramente reducido de nuestra primera implementación del programa en el dispositivo de OpenCL:</p><pre class="code"><span class="comment">//+------------------------------------------------------------------+</span>
<span class="comment">//|&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_1dim.mq5 |</span>
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="preprocessor">#property script_show_inputs</span>

<span class="preprocessor">#define ROWS1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="number">2000</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// rows in the first matrix</span></span>
<span class="preprocessor">#define COLSROWS&nbsp;&nbsp;&nbsp;&nbsp;<span class="number">2000</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// columns in the first matrix = rows in the second matrix </span></span>
<span class="preprocessor">#define COLS2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="number">2000</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// columns in the second matrix</span></span>
<span class="preprocessor">#define REALTYPE&nbsp;&nbsp;&nbsp;&nbsp;float</span>

REALTYPE first[];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="comment">// first linear buffer (matrix)&nbsp;&nbsp;&nbsp;&nbsp; rows1 * colsrows</span>
REALTYPE second[];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="comment">// second buffer&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; colsrows * cols2</span>
REALTYPE thirdGPU[ ];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="comment">// product - also a buffer&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    rows1 * cols2</span>
REALTYPE thirdCPU[ ];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="comment">// product - also a buffer&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;    rows1 * cols2</span>

<span class="keyword">input</span> <span class="keyword">int</span> _device=<span class="number">1</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;<span class="comment">// here is the device; it can be changed (now 4870)</span>

<span class="keyword">string</span> d2s(<span class="keyword">double</span> arg,<span class="keyword">int</span> dig) { <span class="keyword">return</span> <span class="functions">DoubleToString</span>(arg,dig); }
<span class="keyword">string</span> i2s(<span class="keyword">long</span> arg)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; { <span class="keyword">return</span> <span class="functions">IntegerToString</span>(arg); }

<span class="comment">//+------------------------------------------------------------------+</span>
<span class="keyword">const</span> <span class="keyword">string</span> clSrc=
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="string">"#define COLS2&nbsp;&nbsp;&nbsp;&nbsp; "</span>+i2s(COLS2)+<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="string">"#define COLSROWS&nbsp;&nbsp;"</span>+i2s(COLSROWS)+<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="string">"#define REALTYPE&nbsp;&nbsp;float&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="string">"__kernel void matricesMul( __global REALTYPE *in1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __global REALTYPE *in2,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __global REALTYPE *out&nbsp;&nbsp;)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="string">"{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="string">"&nbsp;&nbsp;int r = get_global_id( 0 );&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="string">"&nbsp;&nbsp;int c = get_global_id( 1 );&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="string">"&nbsp;&nbsp;for( int cr = 0; cr &lt; COLSROWS; cr ++ )&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="string">"&nbsp;&nbsp;&nbsp;&nbsp; out[ r * COLS2 + c ] +=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in1[ r * COLSROWS + cr ] * in2[ cr * COLS2 + c ];&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="string">"}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>;
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="comment">//| Main matrix multiplication function;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span>
<span class="comment">//| Input matrices are already generated, </span><span class="comment">                           |
</span><span class="comment">//| </span><span class="comment">the output matrix is initialized to zeros&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;                  |</span>
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="keyword">void</span> mulCPUOneCore()
&nbsp;&nbsp;{
<span class="comment">//--- c-r-cr: 11.544 s </span>
<span class="comment">//st = GetTickCount( );</span>
&nbsp;&nbsp; <span class="keyword">for</span>(<span class="keyword">int</span> c=<span class="number">0</span>; c&lt;COLS2; c++)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>(<span class="keyword">int</span> r=<span class="number">0</span>; r&lt;ROWS1; r++)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="keyword">for</span>(<span class="keyword">int</span> cr=<span class="number">0</span>; cr&lt;COLSROWS; cr++)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;thirdCPU[r*COLS2+c]+=first[r*COLSROWS+cr]*second[cr*COLS2+c];
<span class="comment"></span>
&nbsp;&nbsp; <span class="keyword">return</span>;
&nbsp;&nbsp;}
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="comment">//| Script program start function&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</span>
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="keyword">void</span> <span class="functions">OnStart</span>()
&nbsp;&nbsp;{
&nbsp;&nbsp; initAllDataCPU();

<span class="comment">//--- start working with non-parallel version ("bare" CPU, single core)</span>
<span class="comment">//--- calculate the output matrix on a single core CPU</span>
&nbsp;&nbsp; <span class="keyword">uint</span> st=<span class="functions">GetTickCount</span>();
&nbsp;&nbsp; mulCPUOneCore();

<span class="comment">//--- output total calculation time</span>
&nbsp;&nbsp; <span class="keyword">double</span> timeCPU=(<span class="functions">GetTickCount</span>()-st)/<span class="number">1000</span>.;
&nbsp;&nbsp; <span class="functions">Print</span>(<span class="string">"CPUTime = "</span>+d2s(timeCPU,<span class="number">3</span>));<span class="comment"></span>

<span class="comment">//--- start working with OCL</span>
&nbsp;&nbsp; <span class="keyword">int</span> clCtx;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="comment">// context handle</span>
&nbsp;&nbsp; <span class="keyword">int</span> clPrg;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="comment">// handle to the program on the device</span>
&nbsp;&nbsp; <span class="keyword">int</span> clKrn;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="comment">// kernel handle</span>
&nbsp;&nbsp; <span class="keyword">int</span> clMemIn1;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// first (input) buffer handle</span>
&nbsp;&nbsp; <span class="keyword">int</span> clMemIn2;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// second (input) buffer handle</span>
&nbsp;&nbsp; <span class="keyword">int</span> clMemOut;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// third (output) buffer handle</span>

<span class="comment">//--- start calculating the program runtime on GPU&nbsp;&nbsp;</span>
<span class="comment">//st = GetTickCount( );&nbsp;&nbsp;</span>
&nbsp;&nbsp; initAllDataGPU(clCtx,clPrg,clKrn,clMemIn1,clMemIn2,clMemOut);

<span class="comment">//--- start calculating total OCL code runtime</span>
&nbsp;&nbsp; st=<span class="functions">GetTickCount</span>();

&nbsp;&nbsp; executeGPU(clKrn);

<span class="comment">//--- create a buffer for reading and read the result; we will need it later</span>
&nbsp;&nbsp; REALTYPE buf[];
&nbsp;&nbsp; readOutBuf(clMemOut,buf);

<span class="comment">//--- stop calculating the total program runtime </span>
<span class="comment">//--- together with the time required for retrieval of data from GPU and transferring it back to RAM</span>
&nbsp;&nbsp; <span class="keyword">double</span> timeGPUTotal=(<span class="functions">GetTickCount</span>()-st)/<span class="number">1000</span>.;
&nbsp;&nbsp; <span class="functions">Print</span>(<span class="string">"OpenCL total: time = "</span>+d2s(timeGPUTotal,<span class="number">3</span>)+<span class="string">" sec."</span>);

&nbsp;&nbsp; destroyOpenCL(clCtx,clPrg,clKrn,clMemIn1,clMemIn2,clMemOut);

<span class="comment">//--- calculate the time elapsed</span>
&nbsp;&nbsp; <span class="functions">Print</span>(<span class="string">"CPUTime / GPUTotalTime = "</span>+d2s(timeCPU/timeGPUTotal,<span class="number">3</span>));

<span class="comment">//--- debugging: random checks. Multiplication accuracy is checked directly </span>
<span class="comment">//--- on the initial and output matrices using a few dozen examples</span>
&nbsp;&nbsp; <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">10</span>; i++) checkRandom(buf,ROWS1,COLS2);

&nbsp;&nbsp; <span class="functions">Print</span>(<span class="string">"________________________"</span>);
&nbsp;&nbsp; <span class="keyword">return</span>;
&nbsp;&nbsp;}
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="comment">//| initAllDataCPU&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span>
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="keyword">void</span> initAllDataCPU()
&nbsp;&nbsp;{
<span class="comment">//--- initialize random number generator</span>
&nbsp;&nbsp; <span class="functions">MathSrand</span>(( <span class="keyword">int</span>) <span class="functions">TimeLocal</span>());
&nbsp;&nbsp; <span class="functions">Print</span>(<span class="string">"======================================="</span>);
&nbsp;&nbsp; <span class="functions">Print</span>(<span class="string">"1st OCL martices mul:&nbsp;&nbsp;device = "</span>+i2s(_device)+<span class="string">";&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROWS1 = "</span> +i2s(ROWS1)+<span class="string">
          "; COLSROWS = "</span>+i2s(COLSROWS)+<span class="string">"; COLS2 = "</span>+i2s(COLS2));

<span class="comment">//--- set the required sizes of linear representations of the input and output matrices</span>
&nbsp;&nbsp; <span class="functions">ArrayResize</span>(first,ROWS1*COLSROWS);
&nbsp;&nbsp; <span class="functions">ArrayResize</span>(second,COLSROWS*COLS2);
&nbsp;&nbsp; <span class="functions">ArrayResize</span>(thirdGPU,ROWS1*COLS2);
&nbsp;&nbsp; <span class="functions">ArrayResize</span>(thirdCPU,ROWS1*COLS2);

<span class="comment">//--- generate both input matrices and initialize the output to zeros </span>
&nbsp;&nbsp; genMatrices();
&nbsp;&nbsp; <span class="functions">ArrayInitialize</span>( thirdCPU, <span class="number">0.0</span> );
&nbsp;&nbsp; <span class="functions">ArrayInitialize</span>( thirdGPU, <span class="number">0.0</span> );

&nbsp;&nbsp; <span class="keyword">return</span>;
&nbsp;&nbsp;}
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="comment">//| initAllDataCPU&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span>
<span class="comment">//| lay out in row-major order, Matr[ M (rows) ][ N (columns) ]:&nbsp;&nbsp;&nbsp;&nbsp; |</span>
<span class="comment">//| Matr[row][column] = buff[row * N(columns in the matrix) + column]| </span>
<span class="comment">//| generate initial matrices; this generation is not reflected&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span>
<span class="comment">//| in the final runtime calculation&nbsp;               &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span>
<span class="comment">//| buffers are filled in row-major order!&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span>
<span class="comment">//+------------------------------------------------------------------+&nbsp;&nbsp;</span>
<span class="keyword">void</span> genMatrices()
&nbsp;&nbsp;{
&nbsp;&nbsp; <span class="keyword">for</span>(<span class="keyword">int</span> r=<span class="number">0</span>; r&lt;ROWS1; r++)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>(<span class="keyword">int</span> c=<span class="number">0</span>; c&lt;COLSROWS; c++)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; first[r*COLSROWS+c]=genVal();

&nbsp;&nbsp; <span class="keyword">for</span>(<span class="keyword">int</span> r=<span class="number">0</span>; r&lt;COLSROWS; r++)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>(<span class="keyword">int</span> c=<span class="number">0</span>; c&lt;COLS2; c++)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; second[r*COLS2+c]=genVal();

&nbsp;&nbsp; <span class="keyword">return</span>;
&nbsp;&nbsp;}
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="comment">//| genVal&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; |</span>
<span class="comment">//| generate one value of the matrix element:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; |</span>
<span class="comment">//| uniformly distributed value lying in the range [-0.5; 0.5]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span>
<span class="comment">//+------------------------------------------------------------------+</span>
REALTYPE genVal()
&nbsp;&nbsp;{
&nbsp;&nbsp; <span class="keyword">return</span>(REALTYPE)((<span class="functions">MathRand</span>()-<span class="number">16383.5</span>)/<span class="number">32767</span>.);
&nbsp;&nbsp;}
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="comment">//| initAllDataGPU&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span>
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="keyword">void</span> initAllDataGPU(<span class="keyword">int</span> &amp;clCtx,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="comment">// context</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span>&amp; clPrg,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="comment">// program on the device</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span>&amp; clKrn,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="comment">// kernel</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span>&amp; clMemIn1,&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// first (input) buffer</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span>&amp; clMemIn2,&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// second (input) buffer</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">int</span>&amp; clMemOut)&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">// third (output) buffer</span>
&nbsp;&nbsp;{
<span class="comment">//--- write the kernel code to a file</span>
&nbsp;&nbsp; WriteCLProgram();

<span class="comment">//--- create context, program and kernel</span>
&nbsp;&nbsp; clCtx = CLContextCreate( _device );
&nbsp;&nbsp; clPrg = CLProgramCreate( clCtx, clSrc );
&nbsp;&nbsp; clKrn = CLKernelCreate( clPrg, <span class="string">"matricesMul"</span> );

<span class="comment">//--- create all three buffers for the three matrices</span>
<span class="comment">//--- first matrix - input</span>
&nbsp;&nbsp; clMemIn1=CLBufferCreate(clCtx,ROWS1&nbsp;&nbsp; *COLSROWS*<span class="functions">sizeof</span>(REALTYPE),CL_MEM_READ_WRITE);
<span class="comment">//--- second matrix - input</span>
&nbsp;&nbsp; clMemIn2=CLBufferCreate(clCtx,COLSROWS*COLS2&nbsp;&nbsp; *<span class="functions">sizeof</span>(REALTYPE),CL_MEM_READ_WRITE);
<span class="comment">//--- third matrix - output</span>
&nbsp;&nbsp; clMemOut=CLBufferCreate(clCtx,ROWS1&nbsp;&nbsp; *COLS2&nbsp;&nbsp; *<span class="functions">sizeof</span>(REALTYPE),CL_MEM_READ_WRITE);

<span class="comment">//--- set arguments to the kernel</span>
&nbsp;&nbsp; CLSetKernelArgMem(clKrn,<span class="number">0</span>,clMemIn1);
&nbsp;&nbsp; CLSetKernelArgMem(clKrn,<span class="number">1</span>,clMemIn2);
&nbsp;&nbsp; CLSetKernelArgMem(clKrn,<span class="number">2</span>,clMemOut);

<span class="comment">//--- write the generated matrices to the device buffers</span>
&nbsp;&nbsp; CLBufferWrite(clMemIn1,first);
&nbsp;&nbsp; CLBufferWrite(clMemIn2,second);
&nbsp;&nbsp; CLBufferWrite(clMemOut,thirdGPU);&nbsp;&nbsp; <span class="comment">// 0.0 everywhere</span>

&nbsp;&nbsp; <span class="keyword">return</span>;
&nbsp;&nbsp;}
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="comment">//| WriteCLProgram&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span>
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="keyword">void</span> WriteCLProgram()
&nbsp;&nbsp;{
&nbsp;&nbsp; <span class="keyword">int</span> h=<span class="functions">FileOpen</span>(<span class="string">"matr_mul_OCL_1st.cl"</span>,<span class="macro">FILE_WRITE</span>|<span class="macro">FILE_TXT</span>|<span class="macro">FILE_ANSI</span>);
&nbsp;&nbsp; <span class="functions">FileWrite</span>(h,clSrc);
&nbsp;&nbsp; <span class="functions">FileClose</span>(h);
&nbsp;&nbsp;}
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="comment">//| executeGPU&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span>
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="keyword">void</span> executeGPU(<span class="keyword">int</span> clKrn)
&nbsp;&nbsp;{
<span class="comment">//--- set the workspace parameters for the task and execute the OpenCL program</span>
&nbsp;&nbsp; <span class="keyword">uint</span> offs[ <span class="number">2</span> ]&nbsp;&nbsp;= { <span class="number">0</span>, <span class="number">0</span> };
&nbsp;&nbsp; <span class="keyword">uint</span> works[ <span class="number">2</span> ] = { ROWS1,&nbsp;&nbsp;COLS2 };
&nbsp;&nbsp; <span class="keyword">bool</span> ex=CLExecute(clKrn,<span class="number">2</span>,offs,works);
&nbsp;&nbsp; <span class="keyword">return</span>;
&nbsp;&nbsp;}
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="comment">//| readOutBuf&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span>
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="keyword">void</span> readOutBuf(<span class="keyword">int</span> clMemOut,REALTYPE &amp;buf[])
&nbsp;&nbsp;{
&nbsp;&nbsp; <span class="functions">ArrayResize</span>(buf,COLS2*ROWS1);
<span class="comment">//--- buf - a copy of what is written to the buffer thirdGPU[]</span>
&nbsp;&nbsp; <span class="keyword">uint</span> read=CLBufferRead(clMemOut,buf);
&nbsp;&nbsp; <span class="functions">Print</span>(<span class="string">"read = "</span>+i2s(read)+<span class="string">" elements"</span>);
&nbsp;&nbsp; <span class="keyword">return</span>;
&nbsp;&nbsp;}
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="comment">//| destroyOpenCL&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</span>
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="keyword">void</span> destroyOpenCL(<span class="keyword">int</span> clCtx,<span class="keyword">int</span> clPrg,<span class="keyword">int</span> clKrn,<span class="keyword">int</span> clMemIn1,<span class="keyword">int</span> clMemIn2,<span class="keyword">int</span> clMemOut)
&nbsp;&nbsp;{
<span class="comment">//--- destroy all that was created for calculations on the OpenCL device in reverse order</span>
&nbsp;&nbsp; CLBufferFree(clMemIn1);
&nbsp;&nbsp; CLBufferFree(clMemIn2);
&nbsp;&nbsp; CLBufferFree(clMemOut);
&nbsp;&nbsp; CLKernelFree(clKrn);
&nbsp;&nbsp; CLProgramFree(clPrg);
&nbsp;&nbsp; CLContextFree(clCtx);
&nbsp;&nbsp; <span class="keyword">return</span>;
&nbsp;&nbsp;}
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="comment">//| checkRandom&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|</span>
<span class="comment">//| random check of calculation accuracy&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  &nbsp;&nbsp; |</span>
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="keyword">void</span> checkRandom(REALTYPE &amp;buf[],<span class="keyword">int</span> rows,<span class="keyword">int</span> cols)
&nbsp;&nbsp;{
&nbsp;&nbsp; <span class="keyword">int</span> r0 = genRnd( rows );
&nbsp;&nbsp; <span class="keyword">int</span> c0 = genRnd( cols );

&nbsp;&nbsp; REALTYPE sum=<span class="number">0.0</span>;
&nbsp;&nbsp; <span class="keyword">for</span>(<span class="keyword">int</span> runningIdx=<span class="number">0</span>; runningIdx&lt;COLSROWS; runningIdx++)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sum+=first[r0*COLSROWS+runningIdx]*
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; second[runningIdx*COLS2+c0];
<span class="comment">//--- element of the buffer m[]</span>
&nbsp;&nbsp; REALTYPE bufElement=buf[r0*COLS2+c0];
<span class="comment">//--- element of the matrix not calculated in OpenCL</span>
&nbsp;&nbsp; REALTYPE CPUElement=thirdCPU[r0*COLS2+c0];
&nbsp;&nbsp; <span class="functions">Print</span>(<span class="string">"sum( "</span>+i2s(r0)+<span class="string">","</span>+i2s(c0)+<span class="string">" ) = "</span>+d2s(sum,<span class="number">8</span>)+
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="string">";&nbsp;&nbsp;&nbsp;&nbsp;thirdCPU[ "</span>+i2s(r0)+<span class="string">","</span>+i2s(c0)+<span class="string">" ] = "</span>+d2s(CPUElement,<span class="number">8</span>)+
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="string">";&nbsp;&nbsp;&nbsp;&nbsp;buf[ "</span>+i2s(r0)+<span class="string">","</span>+i2s(c0)+<span class="string">" ] = "</span>+d2s(bufElement,<span class="number">8</span>));
&nbsp;&nbsp; <span class="keyword">return</span>;
&nbsp;&nbsp;}
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="comment">//| genRnd&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; |</span>
<span class="comment">//+------------------------------------------------------------------+</span>
<span class="keyword">int</span> genRnd(<span class="keyword">int</span> max)
&nbsp;&nbsp;{
&nbsp;&nbsp; <span class="keyword">return</span>(<span class="keyword">int</span>)(<span class="functions">MathRand</span>()/<span class="number">32767</span>.*max);
&nbsp;&nbsp;}
</pre><p style="text-align:center;"><span class="small">Listado 2. La primera implementación del algoritmo en OpenCL&nbsp; <br></span></p><p><span class="small"></span></p>

<p>Las dos últimas funciones se útiles para verificar la precisión de los cálculos. Puede descargar todo el código al final del artículo (matr_mul_1dim.mq5). Tenga en cuenta que las dimensiones no tienen que corresponder necesariamente a matrices cuadradas solo.<br></p>

<p>Los demás cambios casi siempre tendrán que ver solo con el código del kernel y por tanto en adelante solo se realizarán códigos de modificación del kernel. <br></p>

<p>El tipo REALTYPE se presenta por comodidad para cambiar la precisión de cálculo de flotante a doble. Debe señalarse que el tipo REALTYPE se declara no solo en el programa anfitrión sino también dentro del kernel. SI es necesario, deberá realizarse cualquier cambio de este tipo en dos lugares al mismo tiempo, en ambos #define del programa anfitrión y en el código kernel.</p>

<p>Los resultados del funcionamiento del código (en adelante, tipo de datos flotantes en todas partes):<br><br>CPU (OpenCL, _device = 0) :<br></p><pre class="code"><span class="number">2012.05</span>.<span class="number">20</span> <span class="number">22</span>:<span class="number">14</span>:<span class="number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_1dim (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime / GPUTotalTime = <span class="number">12.479</span>
<span class="number">2012.05</span>.<span class="number">20</span> <span class="number">22</span>:<span class="number">14</span>:<span class="number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_1dim (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;OpenCL total: time = <span class="number">9.266</span> sec.
<span class="number">2012.05</span>.<span class="number">20</span> <span class="number">22</span>:<span class="number">14</span>:<span class="number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_1dim (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;read = <span class="number">4000000</span> elements
<span class="number">2012.05</span>.<span class="number">20</span> <span class="number">22</span>:<span class="number">14</span>:<span class="number">48</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_1dim (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime = <span class="number">115.628</span>
<span class="number">2012.05</span>.<span class="number">20</span> <span class="number">22</span>:<span class="number">12</span>:<span class="number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_1dim (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;<span class="number">1</span>st OCL martices mul:&nbsp;&nbsp;device = <span class="number">0</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROWS1 = <span class="number">2000</span>; COLSROWS = <span class="number">2000</span>; COLS2 = <span class="number">2000</span>
<span class="number">2012.05</span>.<span class="number">20</span> <span class="number">22</span>:<span class="number">12</span>:<span class="number">52</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_1dim (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;=======================================</pre><p>Cuando se ejecuta en una Radeon HD 4870 (_device = 1):<br></p><pre class="code"><span class="number">2012.05</span>.<span class="number">27</span> <span class="number">01</span>:<span class="number">40</span>:<span class="number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_1dim (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime / GPUTotalTime = <span class="number">9.002</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">01</span>:<span class="number">40</span>:<span class="number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_1dim (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;OpenCL total: time = <span class="number">12.729</span> sec.
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">01</span>:<span class="number">40</span>:<span class="number">50</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_1dim (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;read = <span class="number">4000000</span> elements
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">01</span>:<span class="number">40</span>:<span class="number">37</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_1dim (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime = <span class="number">114.583</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">01</span>:<span class="number">38</span>:<span class="number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_1dim (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;<span class="number">1</span>st OCL martices mul:&nbsp;&nbsp;device = <span class="number">1</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROWS1 = <span class="number">2000</span>; COLSROWS = <span class="number">2000</span>; COLS2 = <span class="number">2000</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">01</span>:<span class="number">38</span>:<span class="number">42</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_1dim (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;=======================================</pre>


<p>Copo puede verse, la ejecución del kernel en la GPU es mucho más lenta. Sin embargo no hemos abordado la optimización específicamente para la GPU.</p>
<p>Algunas conclusiones:</p>
<ul>
<li>El cambio de la representación de la matriz de dos dimensiones a lineal (correspondiente a la representación en el programa ejecutado en el dispositivo) no ha tenido un efecto considerable sobre el tiempo de ejecución total de la versión secuencial del programa.</li>
<li>El algoritmo de cálculo más intuitivo que coincide con la definición de la multiplicación de matrices en el álgebra lineal ha sido elegida como la variante inicial para mayor optimización Es algo más lento que el más rápido, pero en vista de la futura aceleración de la GPU este factor no es esencial.</li>
<li>El tiempo de ejecución debe calcularse solo después de la lectura de los buffers en la RAM en vez de después del comando <a target="_blank" href="https://www.mql5.com/es/docs/opencl/clexecute">CLExecute()</a>. La razón detrás de esto, señalada por <b>MetaDriver</b> al autor, es probablemente la siguiente:<div class="fquote"><b><span style="color:rgb(0, 87, 174);"> MetaDriver: </span></b>Antes de leer del buffer, <a target="_blank" href="https://www.mql5.com/es/docs/opencl/clbufferread">CLBufferRead()</a> simplemente espera la terminación del programa. CLExecute() es de hecho una función de cola de espera asíncrona. Devuelve el resultado inmediatamente, antes de que la operación del código cl se complete.</div></li>
<li>Las guías de computación de GPU no suelen calcular el tiempo de ejecución del kernel sino el rendimiento específico relativo a varios objetos, memoria, aritmética, etc. Podemos hacerlo y lo haremos más adelante. <br></li>
</ul>

<p>Sabemos que el cálculo de una matriz de tamaño 2.000 requiere cerca de 2*2.000 sumas/multiplicaciones para cada elemento. Al multiplicar por el número de elementos de la matriz (2.000*2000) vemos que el número total de operaciones de datos tipo flotante es de 16.000 millones. Dicho esto, la ejecución en la CPU tarda 115,628 seg. que corresponde a una velocidad de flujo de datos igual a </p>

<div class="code">throughput_arithmetic_CPU_no_OCL = 16 000000000 / 115.628 ~ 138 MFlops.<br></div><p><br>Por otro lado, recuerde que el cálculo más rápido hasta ahora en una "CPU de un núcleo" con un tamaño de matriz de 2.000 solo tardó 83,663 segundos en completarse (vea nuestro primer código sin OpenCL). Por tanto<br></p>

<div class="code"><b><span style="color:rgb(0, 87, 174);">throughput_arithmetic_CPU_best_no_OCL = 16 000000000 / 83.663 ~ 191 MFlops.</span></b><br></div><p></p><p>Tomemos esta cifra como referencia, punto de inicio para nuestras optimizaciones. </p>Igualmente, el cálculo usando OpenCL en la CPU arroja:<div class="code">throughput_arithmetic_CPU_OCL =&nbsp; 16 000000000 / 9.266 ~ 1727 MFlops = 1.727 GFlops.<br></div>



<p><br>Finalmente, calculamos el rendimiento específico en la GPU:</p><div class="code">throughput_arithmetic_GPU_OCL =&nbsp; 16 000000000 / 12.729 ~ 1257 MFlops = 1.257 GFlops.<br></div>
<p><br></p>
<p><b>2.3. Eliminar accesos a datos incoherentes </b></p>

<p>Al mirar el código del kernel pueden verse claramente algunos defectos en la optimización.</p><p> Veamos el cuerpo del lazo dentro del kernel:<br></p>

<pre class="code"><span class="keyword">for</span>( <span class="keyword">int</span> cr = <span class="number">0</span>; cr &lt; COLSROWS; cr ++ )
&nbsp;&nbsp; <span class="keyword">out</span>[ r * COLS2 + c ] += in1[ r * COLSROWS + cr ] * in2[ cr * COLS2 + c ];</pre>

<p>Es fácil ver que cuando el contador del lazo (cr++) está ejecutándose se toman datos contiguos del primer buffer en 1[]. Mientras que los datos del segundo buffer en 2[] se tomas con "retrasos" iguales a COLS2. En otras palabras, la mayor parte de los datos tomados del segundo buffer serán inútiles ya que las solicitudes de memoria serán incoherentes (véase <b>1.2.1.</b><b> </b><b>Solicitudes de memoria combinadas)</b> Para arreglar esta situación es suficiente modificar el código en tres sitios cambiando la fórmula de cálculo del índice de la matriz 2 [] así como su patrón de generación:<br></p>- Código del kernel:<br>

<pre class="code"><span class="keyword">for</span>( <span class="keyword">int</span> cr = <span class="number">0</span>; cr &lt; COLSROWS; cr ++ )
&nbsp;&nbsp; <span class="keyword">out</span>[ r * COLS2 + c ] += in1[ r * COLSROWS + cr ] * in2[ cr + c * COLSROWS ];</pre>Ahora cuando los valores del contador del lazo (cr++)  cambian, los datos de ambas matrices se tomarán secuencialmente, sin ningún "retraso".<br><br>- Código de llenado de los buffers en genMatrices(). Ahora debe rellenarse en orden de columna descendiente en lugar de en orden de fila descendente como se usó al principio:<br>

<pre class="code">&nbsp;&nbsp; <span class="keyword">for</span>( <span class="keyword">int</span> r = <span class="number">0</span>; r &lt; COLSROWS; r ++ )
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="keyword">for</span>( <span class="keyword">int</span> c = <span class="number">0</span>; c &lt; COLS2; c ++ )
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span class="comment">/// second[ r * COLS2 + c ] = genVal( );</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; second[ r + c * COLSROWS ] = genVal( );</pre>- Código de verificación en la función checkRandom():<br><pre class="code">&nbsp;&nbsp; <span class="keyword">for</span>( <span class="keyword">int</span> runningIdx = <span class="number">0</span>; runningIdx &lt; COLSROWS; runningIdx ++&nbsp;&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="comment">///sum += first[ r0 * COLSROWS + runningIdx ] * second[ runningIdx * COLS2 + c0 ];</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sum += first[ r0 * COLSROWS + runningIdx ] * second[ runningIdx + c0 * COLSROWS ];</pre>Resultados en la CPU: <br><pre class="code"><span class="number">2012.05</span>.<span class="number">24</span> <span class="number">02</span>:<span class="number">59</span>:<span class="number">22</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_1dim_coalesced (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime / GPUTotalTime = <span class="number">16.207</span>
<span class="number">2012.05</span>.<span class="number">24</span> <span class="number">02</span>:<span class="number">59</span>:<span class="number">22</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_1dim_coalesced (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;OpenCL total: time = <span class="number">5.756</span> sec.
<span class="number">2012.05</span>.<span class="number">24</span> <span class="number">02</span>:<span class="number">59</span>:<span class="number">22</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_1dim_coalesced (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;read = <span class="number">4000000</span> elements
<span class="number">2012.05</span>.<span class="number">24</span> <span class="number">02</span>:<span class="number">59</span>:<span class="number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_1dim_coalesced (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime = <span class="number">93.289</span>
<span class="number">2012.05</span>.<span class="number">24</span> <span class="number">02</span>:<span class="number">57</span>:<span class="number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_1dim_coalesced (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;<span class="number">1</span>st OCL martices mul:&nbsp;&nbsp;device = <span class="number">0</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROWS1 = <span class="number">2000</span>; COLSROWS = <span class="number">2000</span>; COLS2 = <span class="number">2000</span>
<span class="number">2012.05</span>.<span class="number">24</span> <span class="number">02</span>:<span class="number">57</span>:<span class="number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_1dim_coalesced (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;=======================================</pre>Radeon HD 4870:  <br><pre class="code"><span class="number">2012.05</span>.<span class="number">27</span> <span class="number">01</span>:<span class="number">50</span>:<span class="number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_1dim_coalesced (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime / GPUTotalTime = <span class="number">7.176</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">01</span>:<span class="number">50</span>:<span class="number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_1dim_coalesced (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;OpenCL total: time = <span class="number">12.979</span> sec.
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">01</span>:<span class="number">50</span>:<span class="number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_1dim_coalesced (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;read = <span class="number">4000000</span> elements
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">01</span>:<span class="number">50</span>:<span class="number">30</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_1dim_coalesced (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime = <span class="number">93.133</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">01</span>:<span class="number">48</span>:<span class="number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_1dim_coalesced (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;<span class="number">1</span>st OCL martices mul:&nbsp;&nbsp;device = <span class="number">1</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROWS1 = <span class="number">2000</span>; COLSROWS = <span class="number">2000</span>; COLS2 = <span class="number">2000</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">01</span>:<span class="number">48</span>:<span class="number">57</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_1dim_coalesced (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;=======================================
</pre><p>Como podemos ver,  los acceso coherentes a los datos han tenido apenas efecto en el tiempo de ejecución en la GPU, sin embargo mejoró claramente el tiempo de ejecución en la CPU. Es muy probable que tenga que ver con los factores que se optimizarán más tarde, en particular con el tiempo de espera tan prolongado en el acceso a las variables globales de las que deberíamos deshacernos cuanto antes.<br></p><pre class="code">throughput_arithmetic_CPU_OCL =&nbsp;&nbsp;<span class="number">16</span> <span class="number">000000000</span> / <span class="number">5.756</span> ~ <span class="number">2.780</span> GFlops.
throughput_arithmetic_GPU_OCL =&nbsp;&nbsp;<span class="number">16</span> <span class="number">000000000</span> / <span class="number">12.979</span> ~ <span class="number">1.233</span> GFlops.</pre><p>Puede descargar todo el código al final del artículo (matr_mul_1dim_coalesced.mq5). <br></p><p>El código del kernel es el siguiente:</p><pre class="code"><span class="keyword">const</span> <span class="keyword">string</span> clSrc =
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"#define COLS2&nbsp;&nbsp;&nbsp;&nbsp; "</span>&nbsp;&nbsp;&nbsp;&nbsp;+ i2s( COLS2 )&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"#define COLSROWS&nbsp;&nbsp;"</span>&nbsp;&nbsp;&nbsp;&nbsp;+ i2s( COLSROWS ) +&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"#define REALTYPE&nbsp;&nbsp;float&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"__kernel void matricesMul( __global REALTYPE *in1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __global REALTYPE *in2,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __global REALTYPE *out&nbsp;&nbsp;)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;int r = get_global_id( 0 );&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;int c = get_global_id( 1 );&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;for( int cr = 0; cr &lt; COLSROWS; cr ++ )&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp; out[ r * COLS2 + c ] +=&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in1[ r * COLSROWS + cr ] * in2[ cr + c * COLSROWS ];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>;</pre><p style="text-align:center;"><span class="small">Listado 3. Kernel con acceso a datos de memoria global combinado</span><br></p>

<p>Vamos ahora con más optimizaciones.</p><br><b>2.4. Eliminando el acceso a la memoria de GPU global "costoso" de la matriz de salida</b><br><br>

<p>Se sabe que el tiempo de espera del acceso a memoria de la GPU global es extremadamente elevado (casi 600-800 ciclos). Por ejemplo, el tiempo de espera para realizar una suma de dos números es aproximadamente de 20 ciclos. El objetivo principal de las optimizaciones al hacer cálculos en la GPU es ocultar el tiempo de espera incrementando el rendimiento específico de los cálculos. En el lazo del kernel desarrollado anteriormente, hemos accedido constantemente a los elementos de memoria global, lo que cuesta mucho tiempo. <br></p>

<p>Vamos ahora a presentar la suma de la variable local en el kernel (a la que puede accederse muchas veces más rápido ya que es una variable privada del kernel ubicada en la unidad de trabajo del registro) y una vez completado el lazo, asignamos <i>por separado</i> el valor de la suma obtenido al elemento de la matriz de salida:<br></p>

<pre class="code"><span class="keyword">const</span> <span class="keyword">string</span> clSrc =
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"#define COLS2&nbsp;&nbsp;&nbsp;&nbsp; "</span>&nbsp;&nbsp;&nbsp;&nbsp;+ i2s( COLS2 )&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"#define COLSROWS&nbsp;&nbsp;"</span>&nbsp;&nbsp;&nbsp;&nbsp;+ i2s( COLSROWS ) +&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"#define REALTYPE&nbsp;&nbsp;float&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"__kernel void matricesMul( __global REALTYPE *in1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __global REALTYPE *in2,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __global REALTYPE *out&nbsp;&nbsp;)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;int r = get_global_id( 0 );&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;int c = get_global_id( 1 );&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;REALTYPE sum = 0.0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;for( int cr = 0; cr &lt; COLSROWS; cr ++ )&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp; sum += in1[ r * COLSROWS + cr ] * in2[ cr + c * COLSROWS ];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;out[ r * COLS2 + c ] = sum;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span> ;</pre>

<p style="text-align:center;"><span class="small">Listado 4. Introduciendo la variable para calcular la suma acumulada en el lazo de cálculo del producto escalar.</span><br></p>
<p>Puede descargar todo el código al final del artículo (matr_mul_sum_local.mq5).<br><br>CPU:<br></p>

<pre class="code"><span class="number">2012.05</span>.<span class="number">24</span> <span class="number">03</span>:<span class="number">28</span>:<span class="number">17</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_sum_local (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime / GPUTotalTime = <span class="number">24.863</span>
<span class="number">2012.05</span>.<span class="number">24</span> <span class="number">03</span>:<span class="number">28</span>:<span class="number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_sum_local (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;OpenCL total: time = <span class="number">3.759</span> sec.
<span class="number">2012.05</span>.<span class="number">24</span> <span class="number">03</span>:<span class="number">28</span>:<span class="number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_sum_local (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;read = <span class="number">4000000</span> elements
<span class="number">2012.05</span>.<span class="number">24</span> <span class="number">03</span>:<span class="number">28</span>:<span class="number">12</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_sum_local (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime = <span class="number">93.460</span>
<span class="number">2012.05</span>.<span class="number">24</span> <span class="number">03</span>:<span class="number">26</span>:<span class="number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_sum_local (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;<span class="number">1</span>st OCL martices mul:&nbsp;&nbsp;device = <span class="number">0</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROWS1 = <span class="number">2000</span>; COLSROWS = <span class="number">2000</span>; COLS2 = <span class="number">2000</span></pre>GPU HD 4870:<br><pre class="code"><span class="number">2012.05</span>.<span class="number">27</span> <span class="number">01</span>:<span class="number">57</span>:<span class="number">30</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_sum_local (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime / GPUTotalTime = <span class="number">69.541</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">01</span>:<span class="number">57</span>:<span class="number">30</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_sum_local (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;OpenCL total: time = <span class="number">1.326</span> sec.
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">01</span>:<span class="number">57</span>:<span class="number">30</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_sum_local (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;read = <span class="number">4000000</span> elements
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">01</span>:<span class="number">57</span>:<span class="number">28</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_sum_local (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime = <span class="number">92.212</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">01</span>:<span class="number">55</span>:<span class="number">56</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_sum_local (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;<span class="number">1</span>st OCL martices mul:&nbsp;&nbsp;device = <span class="number">1</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROWS1 = <span class="number">2000</span>; COLSROWS = <span class="number">2000</span>; COLS2 = <span class="number">2000</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">01</span>:<span class="number">55</span>:<span class="number">56</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_sum_local (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;=======================================</pre>¡Esto es un auténtico aumento de productividad ! <br><br><pre class="code">throughput_arithmetic_CPU_OCL = <span class="number">16</span> <span class="number">000000000</span> / <span class="number">3.759</span> ~ <span class="number">4.257</span> GFlops.
throughput_arithmetic_GPU_OCL = <span class="number">16</span> <span class="number">000000000</span> / <span class="number">1.326</span> ~ <span class="number">12.066</span> GFlops.
</pre>

<p>El principio fundamental que intentamos seguir en las optimizaciones secuenciales es el siguiente: primero debemos reorganizar la estructura de los datos de la forma más completa posible para que sea adecuada a una tarea dada y específicamente el hardware subyacente, y solo entonces procederemos a refinar las optimizaciones empleando algoritmos de cálculo rápidos como mad() o fma(). Hay que tener en cuenta que las optimizaciones secuenciales no siempre resultan necesariamente en una disminución del rendimiento, esto no puede garantizarse. <br><br></p>

<p><b>2.5. Aumentando las operaciones ejecutadas por el kernel</b><br></p>

<p>En programación paralela es importante organizar los cálculos para minimizar los costes (tiempo invertido) en la organización de la operación paralela. En matrices de dimensión 2.000, una unidad de trabajo calculando un elemento de la matriz de salida realiza una cantidad de trabajo igual a 1 / 4.000.000 de todas las tareas. <br></p><p>Esto es obviamente demasiado y está muy lejos del número real de unidades que realizan cálculos en el hardware. Ahora, en la nueva versión del kernel calcularemos toda la matriz en lugar de un elemento. <br></p>

<p>Es importante que el espacio de la tarea se cambie ahora de dos dimensiones a una dimensión ya que toda la fila, en lugar de un solo elemento de la matriz se calcula ahora en cada tarea del kernel. Por tanto, el espacio de la tarea se convierte en el número de filas de la matriz.<br></p>

<p style="text-align:center;"><img alt="" title="" src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/mul_picture_rowcalc.PNG" height="163" width="666" style="vertical-align:middle;"></p>

<p style="text-align:center;"><span class="small">Fig. 14. Esquema de cálculo de toda la fila de la matriz de salida</span><br></p>

<p>El código del kernel se hace más complejo:<br></p>

<pre class="code"><span class="keyword">const</span> <span class="keyword">string</span> clSrc =
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"#define COLS2&nbsp;&nbsp;&nbsp;&nbsp; "</span>&nbsp;&nbsp;&nbsp;&nbsp;+ i2s( COLS2 )&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"#define COLSROWS&nbsp;&nbsp;"</span>&nbsp;&nbsp;&nbsp;&nbsp;+ i2s( COLSROWS ) +&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"#define REALTYPE&nbsp;&nbsp;float&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"__kernel void matricesMul( __global REALTYPE *in1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __global REALTYPE *in2,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __global REALTYPE *out&nbsp;&nbsp;)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;int r = get_global_id( 0 );&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;REALTYPE sum;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;for( int c = 0; c &lt; COLS2; c ++ )&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp; sum = 0.0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp; for( int cr = 0; cr &lt; COLSROWS; cr ++ )&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sum += in1[ r * COLSROWS + cr ] * in2[ cr + c * COLSROWS ];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp; out[ r * COLS2 + c ] = sum;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span> ;</pre><p style="text-align:center;"><span class="small">Listado 5. El kernel para el cálculo de toda la fila de la matriz de salida</span><br></p>Además, la dimensión de la tarea ha cambiado en la función executeGPU( ):<br><pre class="code"><span class="keyword">void</span> executeGPU( <span class="keyword">int</span> clKrn )
{
&nbsp;&nbsp; <span class="comment">//--- set parameters of the task workspace and execute the OpenCL program</span>
&nbsp;&nbsp; <span class="keyword">uint</span> offs[ <span class="number">1</span> ]&nbsp;&nbsp;= { <span class="number">0</span> };
&nbsp;&nbsp; <span class="keyword">uint</span> works[ <span class="number">1</span> ] = { ROWS1 };&nbsp;&nbsp;
&nbsp;&nbsp; <span class="keyword">bool</span> ex = CLExecute( clKrn, <span class="number">1</span>, offs, works );
&nbsp;&nbsp; <span class="keyword">return</span>;
}<span class="comment"></span></pre>

<p>Los resultados (el código fuente completo está disponible en el archivo matr_mul_row_calc.mq5): <br><br>CPU:<br></p>

<pre class="code"><span class="number">2012.05</span>.<span class="number">24</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_row_calc (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime / GPUTotalTime = <span class="number">17.385</span>
<span class="number">2012.05</span>.<span class="number">24</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_row_calc (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;OpenCL total: time = <span class="number">5.366</span> sec.
<span class="number">2012.05</span>.<span class="number">24</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">24</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_row_calc (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;read = <span class="number">4000000</span> elements
<span class="number">2012.05</span>.<span class="number">24</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">19</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_row_calc (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime = <span class="number">93.288</span>
<span class="number">2012.05</span>.<span class="number">24</span> <span class="number">15</span>:<span class="number">54</span>:<span class="number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_row_calc (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;<span class="number">1</span>st OCL martices mul:&nbsp;&nbsp;device = <span class="number">0</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROWS1 = <span class="number">2000</span>; COLSROWS = <span class="number">2000</span>; COLS2 = <span class="number">2000</span>
<span class="number">2012.05</span>.<span class="number">24</span> <span class="number">15</span>:<span class="number">54</span>:<span class="number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_row_calc (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;=======================================</pre><p>GPU 4870:</p><pre class="code"><span class="number">2012.05</span>.<span class="number">27</span> <span class="number">02</span>:<span class="number">24</span>:<span class="number">10</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_row_calc (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime / GPUTotalTime = <span class="number">55.119</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">02</span>:<span class="number">24</span>:<span class="number">10</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_row_calc (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;OpenCL total: time = <span class="number">1.669</span> sec.
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">02</span>:<span class="number">24</span>:<span class="number">10</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_row_calc (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;read = <span class="number">4000000</span> elements
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">02</span>:<span class="number">24</span>:<span class="number">08</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_row_calc (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime = <span class="number">91.994</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">02</span>:<span class="number">22</span>:<span class="number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_row_calc (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;<span class="number">1</span>st OCL martices mul:&nbsp;&nbsp;device = <span class="number">1</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROWS1 = <span class="number">2000</span>; COLSROWS = <span class="number">2000</span>; COLS2 = <span class="number">2000</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">02</span>:<span class="number">22</span>:<span class="number">35</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_row_calc (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;=======================================</pre>


<p>Podemos ver que el tiempo de ejecución en la CPU ha empeorado claramente y ha sido, aunque no mucho, peor en la GPU. No todo es tan malo: este cambio estratégico que agrava temporalmente la situación a escala local está aquí además para incrementar sustancialmente el rendimiento. <br></p>

<pre class="code">throughput_arithmetic_CPU_OCL = <span class="number">16</span> <span class="number">000000000</span> / <span class="number">5.366</span> ~ <span class="number">2.982</span> GFlops.
throughput_arithmetic_GPU_OCL = <span class="number">16</span> <span class="number">000000000</span> / <span class="number">1.669</span> ~ <span class="number">9.587</span> GFlops.</pre>

<div class="atten">Al hacer la optimización utilizando la API de OpenCL, el tamaño del grupo de trabajo, es decir, el número de unidades de trabajo en el grupo de trabajo, se establece explícitamente. Esta posibilidad no está prevista en la implementación actual por los desarrolladores del terminal. Estaría bien si fuera añadida en futuras versiones.<br></div>

<br>
<p><b>2.6. Transfiriendo la fila de la primera matriz a la memoria privada</b></p>

<p>La principal peculiaridad del algoritmo de multiplicación de la matriz es un gran número de multiplicaciones con acumulación simultanea de los resultados. Una optimización adecuada de gran calidad de este algoritmo debe suponer la minimización de las transferencias de datos. Pero hasta ahora, en los cálculos en el lazo principal de la acumulación del producto escalar, todas las modificaciones de nuestro kernel han guardado dos de las tres matrices en la memoria global. <br></p>

<p>Esto significa que todos los datos de entrada para cada producto escalar (siendo de hecho cada elemento de la matriz de salida) fluye constantemente por toda la jerarquía de la memoria, desde la global a la privada, con los tiempos de espera correspondientes. Este tráfico puede reducirse garantizando que cada unidad de trabajo reutilice siempre la misma fila de la primera matriz para cada fila calculada de la matriz de salida.</p>

<p><br></p><p style="text-align:center;"><img alt="" title="" src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/row_in_private_mem.PNG" height="201" width="543" style="vertical-align:middle;"></p>

<p style="text-align:center;"><span class="small">Fig. 15. Transfiriendo la fila de la primera matriz a la memoria privada de la unidad de trabajo</span><br></p>

<p>Esto no conlleva ningún cambio en el código del programa anfitrión. Y los cambios en el kernel son mínimos. Debido al hecho de que una matriz de una dimensión privada se genera dentro del kernel, la GPU intenta ubicarla en la memoria privada de la unidad que ejecuta el kernel. La fila requerida de la primera matriz es simplemente copiada de la memoria global a la privada. Dicho esto, debe señalarse que incluso este copiado será relativamente rápido. El truco está en el hecho de que el copiado más costoso de los elementos de la primera matriz de la memoria global a la privada se hace coherentemente y los costes adicionales de copiado son muy modestos comparados con el tiempo de ejecución del doble lazo principal calculando la fila de la matriz de salida.</p>

<p>El código el kernel (el código comentado en el lazo principal es el mismo de la versión anterior):<br></p>

<pre class="code"><span class="keyword">const</span> <span class="keyword">string</span> clSrc =
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"#define COLS2&nbsp;&nbsp;&nbsp;&nbsp; "</span>&nbsp;&nbsp;&nbsp;&nbsp;+ i2s( COLS2 )&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"#define COLSROWS&nbsp;&nbsp;"</span>&nbsp;&nbsp;&nbsp;&nbsp;+ i2s( COLSROWS ) +&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"#define REALTYPE&nbsp;&nbsp;float&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"__kernel void matricesMul( __global REALTYPE *in1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __global REALTYPE *in2,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __global REALTYPE *out&nbsp;&nbsp;)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;int r = get_global_id( 0 );&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;REALTYPE rowbuf[ COLSROWS ];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;for( int col = 0; col &lt; COLSROWS; col ++ )&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp; rowbuf[ col ] = in1[ r * COLSROWS + col ];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;REALTYPE sum;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>&nbsp;&nbsp;&nbsp;&nbsp; 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;for( int c = 0; c &lt; COLS2; c ++ )&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp; sum = 0.0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp; for( int cr = 0; cr &lt; COLSROWS; cr ++ )&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;///sum += in1[ r * COLSROWS + cr ] * in2[ cr + c * COLSROWS ];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sum += rowbuf[ cr ] * in2[ cr + c * COLSROWS ];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp; out[ r * COLS2 + c ] = sum;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span> ;</pre><p style="text-align:center;"><span class="small">Listado 6. Kernel con la fila de la primera matriz a la memoria privada de la unidad de trabajo</span></p>CPU:<br><pre class="code"><span class="number">2012.05</span>.<span class="number">27</span> <span class="number">00</span>:<span class="number">51</span>:<span class="number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_row_in_private (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime / GPUTotalTime = <span class="number">18.587</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">00</span>:<span class="number">51</span>:<span class="number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_row_in_private (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;OpenCL total: time = <span class="number">4.961</span> sec.
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">00</span>:<span class="number">51</span>:<span class="number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_row_in_private (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;read = <span class="number">4000000</span> elements
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">00</span>:<span class="number">51</span>:<span class="number">41</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_row_in_private (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime = <span class="number">92.212</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">00</span>:<span class="number">50</span>:<span class="number">08</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_row_in_private (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;<span class="number">1</span>st OCL martices mul:&nbsp;&nbsp;device = <span class="number">0</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROWS1 = <span class="number">2000</span>; COLSROWS = <span class="number">2000</span>; COLS2 = <span class="number">2000</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">00</span>:<span class="number">50</span>:<span class="number">08</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_row_in_private (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;=======================================</pre>GPU:<br><pre class="code"><span class="number">2012.05</span>.<span class="number">27</span> <span class="number">02</span>:<span class="number">28</span>:<span class="number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_row_in_private (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime / GPUTotalTime = <span class="number">69.242</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">02</span>:<span class="number">28</span>:<span class="number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_row_in_private (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;OpenCL total: time = <span class="number">1.327</span> sec.
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">02</span>:<span class="number">28</span>:<span class="number">49</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_row_in_private (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;read = <span class="number">4000000</span> elements
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">02</span>:<span class="number">28</span>:<span class="number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_row_in_private (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime = <span class="number">91.884</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">02</span>:<span class="number">27</span>:<span class="number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_row_in_private (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;<span class="number">1</span>st OCL martices mul:&nbsp;&nbsp;device = <span class="number">1</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROWS1 = <span class="number">2000</span>; COLSROWS = <span class="number">2000</span>; COLS2 = <span class="number">2000</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">02</span>:<span class="number">27</span>:<span class="number">15</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_row_in_private (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;=======================================</pre><pre class="code">throughput_arithmetic_CPU_OCL = <span class="number">16</span> <span class="number">000000000</span> / <span class="number">4.961</span> ~ <span class="number">3.225</span> GFlops.
throughput_arithmetic_GPU_OCL = <span class="number">16</span> <span class="number">000000000</span> / <span class="number">1.327</span> ~ <span class="number">12.057</span> GFlops.</pre>

<p>El rendimiento específico de la CPU sigue siendo del mismo nivel que la última vez, mientras que el rendimiento específico de la GPU volvió al nivel más alto alcanzado, pero en la nueva capacidad. Tenga en cuenta que el rendimiento específico de la CPU es como si se hubiera congelado, siendo solo ligeramente inestable, mientras el rendimiento específico de la GPU sube (aunque no siempre) en saltos muy grandes.<br></p>

<p>Es preciso señalar que el rendimiento específico real debe ser un poco mayor ya que, debido al copiado de la fila de la primera matriz en la memoria privada, se ejecutan más operaciones ahora que antes. Sin embargo, tiene poco efecto en el rendimiento específico estimado final.</p>

<p>El código fuente puede consultarse en matr_mul_row_in_private.mq5. <br></p>



<p><br></p><p><b>2.7. Transfiriendo la columna de la segunda matriz a la memoria local</b></p><p>Ahora es fácil adivinar cuál será el siguiente paso. Ya hemos seguido los pasos para ocultar los tiempos de espera asociados con el resultado y las primeras matrices de entrada. Queda aún una segunda matriz.&nbsp; <br></p>

<p>Un estudio más detallado de los productos escalares en la multiplicación de matrices muestra que durante el cálculo de la fila de la matriz de salida, todas las unidades de trabajo en el grupo de trabajo refluyen datos de las mismas columnas de la segunda matriz multiplicada a través del dispositivo. Esto se muestra en el esquema a continuación:<br><br></p>

<p style="text-align:center;"><img alt="" title="" src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/row_private_col_local.PNG" height="204" width="515" style="vertical-align:middle;"></p><p style="text-align:center;"><span class="small">Fig. 16. Transfiriendo la columna de la segunda matriz a la <i>cuota de datos local </i>del grupo de trabajo.</span></p>

<p>Los costes de transferir datos de la memoria global pueden reducirse si las unidades de trabajo que conforman el grupo de trabajo copian las columnas de la segunda matriz en la memoria del grupo de trabajo antes de que comience el cálculo de las filas de la matriz de salida. <br></p>

<p>Esto requerirá realizar cambios en el kernel así como en el programa anfitrión. El cambio más importante es el establecimiento de la memoria local para cada kernel. Debe ser explícito ya que la asignación de memoria dinámica no está soportada en OpenCL. Por tanto, debe ubicarse primer en el anfitrión un objeto de memoria de tamaño adecuado para que sea posteriormente procesado dentro del kernel. <br></p>

<p>Y solo entonces, al ejecutar el kernel, las unidades de trabajo copian la columna de la segunda matriz en la memoria local. Esto se hace en paralelo utilizando la distribución cíclica de iteraciones de lazo en todas las unidades del grupo de trabajo. Sin embargo, todo el copiado debe completarse antes de la que la unidad de trabajo comience su operación principal (cálculo de la fila de la matriz de salida). <br></p><p>Por ello se inserta el siguiente comando después del lazo encargado del copiado:</p>

<pre class="code">barrier(CLK_LOCAL_MEM_FENCE);</pre>

<p>Esta es una "barrera de memoria local" que garantiza que cada unidad de trabajo en el grupo puede "ver" la memoria local en un cierto estado que es coordinado con otras unidades. Todas las unidades de trabajo en el grupo de trabajo deben ejecutar comandos hasta la barrera antes de que cualquiera de ellos pueda proceder con la ejecución del kernel. En otras palabras, la barrera es un mecanismo de sincronización especial entre las unidades de trabajo dentro del grupo de trabajo. <br></p>

<p>Los mecanismos de sincronización entre los grupos de trabajo no se han previsto en OpenCL.</p>

<p> A continuación se muestra una ilustración de la barrera en acción:</p><p style="text-align:center;"><img alt="Fig. 17. Ilustración de la barrera en acción" title="Fig. 17. Ilustración de la barrera en acción" src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/barrier__2.PNG" height="348" width="726" style="vertical-align:middle;"><br></p>

<p style="text-align:center;"><span class="small">Fig. 17. Ilustración de la barrera en acción<br></span></p><p>De hecho, solo parece que las unidades de trabajo en el grupo ejecutan el código estrictamente de forma simultánea. Esto es solo una abstracción del modelo de programación de OpenCL. <br></p>

<p>Hasta ahora, nuestros códigos de kernel ejecutados en diferentes unidades de trabajo no han requerido una sincronización de las operaciones ya que no hubo comunicación explícita entre ellos que estuviera establecida de forma programática en el kernel, y además, no era siquiera necesario. Sin embargo, se requiere la sincronización en este kernel ya que el proceso de llenado de la matriz local se distribuye en <i>paralelo entre todas las unidades del grupo de trabajo</i>. <br></p><p>En otras palabras, cada unidad de trabajo escribe sus valores en cuota de datos local (aquí, en la matriz) sin saber lo lejos que están de otras unidades en este proceso de escritura. La barrera está ahí para que una determinada unidad de trabajo no proceda con la ejecución del kernel antes de que sea necesario, es decir, antes de que una matriz local se haya generado por completo.<br></p>

<p>Debe entender que esta optimización difícilmente beneficiará al rendimiento de la CPU: La guía de optimización de OpenCL de Intel dice que cuando ejecutamos un kernel en la CPU, todos los objetos de memoria son capturados por el hardware, por lo que el cambio explícito usando la memoria local introduce costes innecesarios (moderados).<br></p>

<p>Hay otro punto importante que merece destacar aquí y que costó mucho tiempo al autor del artículo. Tiene que ver con el hecho de que una variable local no puede pasarse en el encabezado de la función kernel, es decir, en la etapa de compilación, en la implementación actual por los desarrolladores del terminal. La razón detrás de esto es que para asignar memoria a un objeto de memoria como argumento de la función del kernel, tendríamos primero que crear explícitamente ese objeto en la memoria CPU usando la función <a target="_blank" href="https://www.mql5.com/es/docs/opencl/clbuffercreate">CLBufferCreate()</a> y especificar explícitamente su tamaño como función parámetro. Esta función devuelve un controlador de objeto de memoria que será almacenado posteriormente en la memoria de la CPU global ya que este es el único lugar donde puede estar.<br></p>



<p>La memoria local, sin embargo, es una memoria diferente de la global y por tanto un objeto de memoria creado no puede situarse en la memoria local del grupo de trabajo.<br></p><p>La API de OpenCL permite asignar memoria explícitamente en el tamaño requerido con el puntero NULL al argumento del kernel, incluso sin crear el objeto de memoria como tal (función <a target="_blank" href="https://www.mql5.com/es/docs/opencl/clsetkernelarg">CLSetKernelArg()</a>). Sin embargo, la sintaxis de la función <a target="_blank" href="https://www.mql5.com/es/docs/opencl/clsetkernelargmem">CLSetKernelArgMem()</a> siendo la análoga de la función API no nos permite pasar en ella el tamaño de la memoria asignada al argumento sin crear el objeto de memoria mismo. Lo que podemos pasar a la función <a target="_blank" href="https://www.mql5.com/es/docs/opencl/clsetkernelargmem">CLSetKernelArgMem()</a> es solo el controlador del buffer ya generado en la memoria de CPU global y pensado para ser transferido a la memoria de la CPU global. Esta es la paradoja.<br></p>

<p>Por suerte, hay una forma equivalente de trabajar con buffers locales en el kernel. Simplemente declaramos dicho buffer con el modificador __local en el cuerpo del kernel. La memoria local asignada al grupo de trabajo será determinada durante el tiempo de ejecución en lugar de en la etapa de compilación.<br></p>

<p>Los comandos que lleguen después de la barrera al kernel (la línea de la barrera en el código está marcada en rojo) son, en esencia, los mismo que en la optimización previa. El código del programa anfitrión sigue siendo el mismo (el código fuente está disponible en matr_mul_col_local.mq5). <br></p>

<p>Este es el nuevo código del kernel:</p>

<pre class="code"><span class="keyword">const</span> <span class="keyword">string</span> clSrc =
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"#define COLS2&nbsp;&nbsp;&nbsp;&nbsp; "</span>&nbsp;&nbsp;&nbsp;&nbsp;+ i2s( COLS2 )&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"#define COLSROWS&nbsp;&nbsp;"</span>&nbsp;&nbsp;&nbsp;&nbsp;+ i2s( COLSROWS ) +&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"#define REALTYPE&nbsp;&nbsp;float&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"__kernel void matricesMul( __global REALTYPE *in1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __global REALTYPE *in2,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __global REALTYPE *out )&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;int r = get_global_id( 0 );&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;REALTYPE rowbuf[ COLSROWS ];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;for( int col = 0; col &lt; COLSROWS; col ++ )&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp; rowbuf[ col ] = in1[ r * COLSROWS + col ];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;int idlocal = get_local_id( 0 );&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>&nbsp;&nbsp;&nbsp;&nbsp; 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;int nlocal = get_local_size( 0 );&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>&nbsp;&nbsp;&nbsp;&nbsp; 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;__local&nbsp;&nbsp;REALTYPE colbuf[ COLSROWS ] ;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span> 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;REALTYPE sum;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;for( int c = 0; c &lt; COLS2; c ++ )&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp; for( int cr = idlocal; cr &lt; COLSROWS; cr = cr + nlocal )&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;colbuf[ cr ] = in2[ cr + c * COLSROWS ];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp; <span style="color:rgb(226, 8, 0);"><b>barrier( CLK_LOCAL_MEM_FENCE );</b></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp; sum = 0.0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp; for( int cr = 0; cr &lt; COLSROWS; cr ++ )&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sum += rowbuf[ cr ] * colbuf[ cr ];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp; out[ r * COLS2 + c ] = sum;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span> ;</pre><p style="text-align:center;"><span class="small">Listado 7. Transfiriendo la columna de la segunda matriz a la <i>memoria local </i>del grupo de trabajo.</span><br></p>CPU:<br><pre class="code"><span class="number">2012.05</span>.<span class="number">27</span> <span class="number">06</span>:<span class="number">31</span>:<span class="number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_col_local (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime / GPUTotalTime = <span class="number">17.630</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">06</span>:<span class="number">31</span>:<span class="number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_col_local (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;OpenCL total: time = <span class="number">5.227</span> sec.
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">06</span>:<span class="number">31</span>:<span class="number">46</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_col_local (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;read = <span class="number">4000000</span> elements
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">06</span>:<span class="number">31</span>:<span class="number">40</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_col_local (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime = <span class="number">92.150</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">06</span>:<span class="number">30</span>:<span class="number">08</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_col_local (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;<span class="number">1</span>st OCL martices mul:&nbsp;&nbsp;device = <span class="number">0</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROWS1 = <span class="number">2000</span>; COLSROWS = <span class="number">2000</span>; COLS2 = <span class="number">2000</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">06</span>:<span class="number">30</span>:<span class="number">08</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_col_local (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;=======================================</pre>GPU:<br><pre class="code"><span class="number">2012.05</span>.<span class="number">27</span> <span class="number">06</span>:<span class="number">21</span>:<span class="number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_col_local (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime / GPUTotalTime = <span class="number">58.069</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">06</span>:<span class="number">21</span>:<span class="number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_col_local (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;OpenCL total: time = <span class="number">1.592</span> sec.
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">06</span>:<span class="number">21</span>:<span class="number">36</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_col_local (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;read = <span class="number">4000000</span> elements
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">06</span>:<span class="number">21</span>:<span class="number">34</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_col_local (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime = <span class="number">92.446</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">06</span>:<span class="number">20</span>:<span class="number">01</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_col_local (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;<span class="number">1</span>st OCL martices mul:&nbsp;&nbsp;device = <span class="number">1</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROWS1 = <span class="number">2000</span>; COLSROWS = <span class="number">2000</span>; COLS2 = <span class="number">2000</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">06</span>:<span class="number">20</span>:<span class="number">01</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_col_local (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;=======================================
</pre>

<p>Ambos casos muestran el deterioro del rendimiento que sin embargo no puede llamarse significativa. Puede ser que el rendimiento mejore en lugar de deteriorarse cambiando el tamaño del grupo de trabajo. El ejemplo anterior servirá además a un propósito diferente: para mostrar cómo usar objetos de la memoria local.<br></p>

<p>Hay una hipótesis que explica un descenso en el rendimiento cuando se usa la memoria local El artículo <a href="https://www.mql5.com/go?http://habrahabr.ru/post/96122/" title="http://habrahabr.ru/post/96122/" target="_blank">comparando OpenCL con CUDA, GLSL y OpenMP</a> (en ruso) publicado en habrahabr.ru hace casi dos años dice: </p>

<div class="fquote">Las tarjetas AMD no soportan la memoria local a nivel físico, en su lugar, la región de la memoria local se mapea sobre la memoria global. <br></div>Justo debajo del mismo artículo, el autor comentaba lo siguiente:

<div class="fquote">Las tarjetas AMD probadas no tenían físicamente memoria de chip y por tanto algunos algoritmos que requerían memoria local se ralentizaron dramáticamente.<br></div>

<p>En otras palabras, ¿significa esto que la memoria local de los productos que salieron al mercado hace dos años no eran más rápidos que la memoria global? La fecha en la que dichos comentarios fueron publicados sugiere que hace dos años la serie de tarjetas gráficas Radeon HD 58xx que salieron, según el autor, eran bastante poco optimistas. Creo que es difícil de creer, especialmente dada la sensacional serie Evergreen de AMD. Sería interesante comprobarlo usando tarjetas más modernas, p. ej. las series HD 69xx.&nbsp; <br></p>

<div class="atten"><p>Adición: inicie el GPU Caps Viewer y verá lo siguiente en la pestaña de OpenCL:</p><p style="text-align:center;"><img alt="Fig. 18. Parámetros principales de OpenCL soportados por HD 4870" title="Fig. 18. Parámetros principales de OpenCL soportados por HD 4870" src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/gpucaps_param_local_mem_type__1.GIF" height="540" width="356" style="vertical-align:middle;"><br></p><p style="text-align:center;"><span class="small">Fig. 18. Parámetros principales de OpenCL soportados por HD 4870</span><br></p></div><div class="code"><p>CL_DEVICE_LOCAL_MEM_TYPE: Global<br></p></div>

<div class="atten"><p>La explicación de este parámetro proporcionada en la especificación del lenguaje (Tabla 4.3, p. 41) es la siguiente:</p>

<div class="fquote"><p>Tipo de memoria local soportada. Esto puede establecerse a CL_LOCAL implicando el almacenamiento de memoria local dedicada como SRAM o CL_GLOBAL.<br></p></div><p>De esta forma, la memoria local de la HD 4870 es realmente una parte de la memoria global y cualquier manipulación de la memoria local en esta tarjeta gráfica es por tanto inútil y no dará ningún resultado nada más rápido que la memoria global. <a href="https://www.mql5.com/go?http://devgurus.amd.com/message/1171540[hash]1171540" title="http://devgurus.amd.com/message/1171540[hash]1171540" target="_blank">Aquí</a> hay otro enlace donde los especialistas de AMD aclaran este punto para las series HD 4xxx. Esto no significa necesariamente que sea tan malo para la tarjeta gráfica que tengamos, era solo para mostrar dónde puede encontrarse dicha información sobre el hardware, en este caso, en CPU Caps Viewer.<br></p></div>

<pre class="code">throughput_arithmetic_CPU_OCL = <span class="number">16</span> <span class="number">000000000</span> / <span class="number">5.227</span> ~ <span class="number">3.061</span> GFlops.
throughput_arithmetic_GPU_OCL = <span class="number">16</span> <span class="number">000000000</span> / <span class="number">1.592</span> ~ <span class="number">10.050</span> GFlops.
</pre>

<p>Finalmente, vamos a añadir uno toques finales vectorizando el kernel explícitamente. El kernel que se obtuvo en la etapa de transferencia de la fila de la primera matriz a la memoria privada (matr_mul_row_in_private.mq5) servirá como kernel inicial ya que parece que es el más rápido.<br><br><br></p>



<p><b>2.8. Vectorización del kernel</b></p><p>Esta operación se desglosará mejor en varias etapas, para evitar la confusión. En la modificación inicial, no cambiamos los tipos de datos de los parámetros externos del kernel y solo vectorizamos los cálculos de el lazo interno:<br></p>

<pre class="code"><span class="keyword">const</span> <span class="keyword">string</span> clSrc =
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"#define COLS2&nbsp;&nbsp;&nbsp;&nbsp; "</span>&nbsp;&nbsp;&nbsp;&nbsp;+ i2s( COLS2 )&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"#define COLSROWS&nbsp;&nbsp;"</span>&nbsp;&nbsp;&nbsp;&nbsp;+ i2s( COLSROWS ) +&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"#define REALTYPE&nbsp;&nbsp;float&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"#define REALTYPE4 float4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>&nbsp;&nbsp;&nbsp;&nbsp; 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"__kernel void matricesMul( __global REALTYPE *in1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __global REALTYPE *in2,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __global REALTYPE *out&nbsp;&nbsp;)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;int r = get_global_id( 0 );&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;REALTYPE rowbuf[ COLSROWS ];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;for( int col = 0; col &lt; COLSROWS; col ++ )&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp; rowbuf[ col ] =&nbsp;&nbsp;in1[r * COLSROWS + col ];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>&nbsp;&nbsp;&nbsp;&nbsp; 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;REALTYPE sum;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>&nbsp;&nbsp;&nbsp;&nbsp; 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;for( int c = 0; c &lt; COLS2; c ++ )&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp; sum = 0.0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp; for( int cr = 0; cr &lt; COLSROWS; cr += 4 )&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sum += dot( ( REALTYPE4 ) ( rowbuf[ cr ],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rowbuf[ cr + 1 ],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>&nbsp;&nbsp;&nbsp;&nbsp; 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rowbuf[ cr + 2 ],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>&nbsp;&nbsp;&nbsp;&nbsp; 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rowbuf[ cr + 3 ] ),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>&nbsp;&nbsp;&nbsp;&nbsp; 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( REALTYPE4 ) ( in2[c * COLSROWS + cr&nbsp;&nbsp;&nbsp;&nbsp; ],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in2[c * COLSROWS + cr + 1 ],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in2[c * COLSROWS + cr + 2 ],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in2[c * COLSROWS + cr + 3 ] ) );&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp; out[ r * COLS2 + c ] = sum;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span> ;</pre><p style="text-align:center;"><span class="small">Listado 8. Vectorización parcial del kernel usando float4 (solo lazo interno)<br></span></p>El código fuente completo está en el archivo matr_mul_vect.mq5. Es necesario, por supuesto, que el parámetro COLSROWS sea divisible por 4.<br><br>CPU:<br><pre class="code"><span class="number">2012.05</span>.<span class="number">27</span> <span class="number">21</span>:<span class="number">28</span>:<span class="number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime / GPUTotalTime = <span class="number">18.657</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">21</span>:<span class="number">28</span>:<span class="number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;OpenCL total: time = <span class="number">4.945</span> sec.
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">21</span>:<span class="number">28</span>:<span class="number">16</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;read = <span class="number">4000000</span> elements
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">21</span>:<span class="number">28</span>:<span class="number">11</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime = <span class="number">92.259</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">21</span>:<span class="number">26</span>:<span class="number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;<span class="number">1</span>st OCL martices mul:&nbsp;&nbsp;device = <span class="number">0</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROWS1 = <span class="number">2000</span>; COLSROWS = <span class="number">2000</span>; COLS2 = <span class="number">2000</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">21</span>:<span class="number">26</span>:<span class="number">38</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;=======================================</pre><br>GPU:<br><pre class="code"><span class="number">2012.05</span>.<span class="number">27</span> <span class="number">21</span>:<span class="number">21</span>:<span class="number">30</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime / GPUTotalTime = <span class="number">78.079</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">21</span>:<span class="number">21</span>:<span class="number">30</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;OpenCL total: time = <span class="number">1.186</span> sec.
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">21</span>:<span class="number">21</span>:<span class="number">30</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;read = <span class="number">4000000</span> elements
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">21</span>:<span class="number">21</span>:<span class="number">28</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime = <span class="number">92.602</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">21</span>:<span class="number">19</span>:<span class="number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;<span class="number">1</span>st OCL martices mul:&nbsp;&nbsp;device = <span class="number">1</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROWS1 = <span class="number">2000</span>; COLSROWS = <span class="number">2000</span>; COLS2 = <span class="number">2000</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">21</span>:<span class="number">19</span>:<span class="number">55</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;=======================================</pre><br><p>Por sorpresa incluso esta primitiva vectorización ha dado buenos resultados en la GPU, aunque no muy significativos, la ganancia parece ser del 10%. <br></p><p>Sigamos vectorizando dentro del kernel: transferimos las costosas operaciones de conversión de tipo vector REALTYPE4 junto con la especificación de los componentes del vector específicos al lazo auxiliar externo rellenando la variable privada rowbuf[]. No hay cambios en el algoritmo:<br></p><pre class="code"><span class="keyword">const</span> <span class="keyword">string</span> clSrc =
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"#define COLS2&nbsp;&nbsp;&nbsp;&nbsp; "</span>&nbsp;&nbsp;&nbsp;&nbsp;+ i2s( COLS2 )&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"#define COLSROWS&nbsp;&nbsp;"</span>&nbsp;&nbsp;&nbsp;&nbsp;+ i2s( COLSROWS ) +&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"#define REALTYPE&nbsp;&nbsp;float&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"#define REALTYPE4 float4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>&nbsp;&nbsp;&nbsp;&nbsp; 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"__kernel void matricesMul( __global REALTYPE *in1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __global REALTYPE *in2,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __global REALTYPE *out&nbsp;&nbsp;)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;int r = get_global_id( 0 );&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;REALTYPE4 rowbuf[ COLSROWS / 4 ];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;for( int col = 0; col &lt; COLSROWS / 4; col ++ )&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp; rowbuf[ col ] =&nbsp;&nbsp;( REALTYPE4 ) ( in1[r * COLSROWS + 4 * col ],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in1[r * COLSROWS + 4 * col + 1 ],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in1[r * COLSROWS + 4 * col + 2 ],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in1[r * COLSROWS + 4 * col + 3 ] );&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>&nbsp;&nbsp;&nbsp;&nbsp; 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;REALTYPE sum;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>&nbsp;&nbsp;&nbsp;&nbsp; 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;for( int c = 0; c &lt; COLS2; c ++ )&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp; sum = 0.0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp; for( int cr = 0; cr &lt; COLSROWS / 4; cr ++ )&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sum += dot(&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; rowbuf[ cr ],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( REALTYPE4 ) ( in2[c * COLSROWS + 4 * cr&nbsp;&nbsp;&nbsp;&nbsp; ],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in2[c * COLSROWS + 4 * cr + 1 ],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in2[c * COLSROWS + 4 * cr + 2 ],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in2[c * COLSROWS + 4 * cr + 3 ] ) );&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp; out[ r * COLS2 + c ] = sum;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span> ;</pre>

<p style="text-align:center;"><span class="small">Listado 9. Deshaciéndonos de las costosas operaciones de conversión de tipo en el lazo principal del kernel</span></p>

<p>Tenga en cuenta que el valor de recuento máximo del contador del lazo interno (y del auxiliar) ha sido 4 veces más lento ya que las operaciones de lectura que son ahora necesarias para la primera matriz son 4 veces menores que antes, la lectura se ha vuelto claramente una operación de vector.<br></p>CPU:  <br>

<pre class="code"><span class="number">2012.05</span>.<span class="number">27</span> <span class="number">22</span>:<span class="number">41</span>:<span class="number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect_v2 (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime / GPUTotalTime = <span class="number">24.480</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">22</span>:<span class="number">41</span>:<span class="number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect_v2 (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;OpenCL total: time = <span class="number">3.791</span> sec.
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">22</span>:<span class="number">41</span>:<span class="number">43</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect_v2 (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;read = <span class="number">4000000</span> elements
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">22</span>:<span class="number">41</span>:<span class="number">39</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect_v2 (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime = <span class="number">92.805</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">22</span>:<span class="number">40</span>:<span class="number">06</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect_v2 (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;<span class="number">1</span>st OCL martices mul:&nbsp;&nbsp;device = <span class="number">0</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROWS1 = <span class="number">2000</span>; COLSROWS = <span class="number">2000</span>; COLS2 = <span class="number">2000</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">22</span>:<span class="number">40</span>:<span class="number">06</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect_v2 (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;=======================================</pre>GPU:<br><pre class="code"><span class="number">2012.05</span>.<span class="number">27</span> <span class="number">22</span>:<span class="number">35</span>:<span class="number">28</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect_v2 (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime / GPUTotalTime = <span class="number">185.605</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">22</span>:<span class="number">35</span>:<span class="number">28</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect_v2 (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;OpenCL total: time = <span class="number">0.499</span> sec.
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">22</span>:<span class="number">35</span>:<span class="number">28</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect_v2 (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;read = <span class="number">4000000</span> elements
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">22</span>:<span class="number">35</span>:<span class="number">27</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect_v2 (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime = <span class="number">92.617</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">22</span>:<span class="number">33</span>:<span class="number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect_v2 (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;<span class="number">1</span>st OCL martices mul:&nbsp;&nbsp;device = <span class="number">1</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROWS1 = <span class="number">2000</span>; COLSROWS = <span class="number">2000</span>; COLS2 = <span class="number">2000</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">22</span>:<span class="number">33</span>:<span class="number">54</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect_v2 (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;=======================================</pre>Resultados específicos aritméticos:<br><pre class="code">throughput_arithmetic_CPU_OCL = <span class="number">16</span> <span class="number">000000000</span> / <span class="number">3.791</span> ~ <span class="number">4.221</span> GFlops.
throughput_arithmetic_GPU_OCL = <span class="number">16</span> <span class="number">000000000</span> / <span class="number">0.499</span> ~ <span class="number">32.064</span> GFlops.</pre>

<p>Como puede verse, los cambios en el rendimiento para la CPU son considerables, mientras que son casi revolucionarios para la GPU. El código fuente puede consultarse en matr_mul_vect_v2.mq5.<br></p>

<p>Vamos a realizar las mismas operaciones con respecto a la última variante del kernel, usando solo el ancho de vector 8. La decisión del autor puede explicarse por el hecho de que el ancho de banda de la memoria de la GPU es 256 bits, es decir, 32 bytes u ocho números de tipo flotante, por tanto, el procesado simultaneo de 8 números flotantes que es equivalente al uso actual de float8 parece ser muy natural. <br></p>

<p>Tenga en cuenta que en este caso el valor de COLSROWS debe ser divisible por 8. Este es un requisito natural ya que las optimizaciones más precisas establecen requisitos más específicos para los datos. <br></p>

<pre class="code"><span class="keyword">const</span> <span class="keyword">string</span> clSrc =
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"#define COLS2&nbsp;&nbsp;&nbsp;&nbsp; "</span>&nbsp;&nbsp;&nbsp;&nbsp;+ i2s( COLS2 )&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"#define COLSROWS&nbsp;&nbsp;"</span>&nbsp;&nbsp;&nbsp;&nbsp;+ i2s( COLSROWS ) +&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"#define REALTYPE&nbsp;&nbsp;float&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"#define REALTYPE4 float4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>&nbsp;&nbsp;&nbsp;&nbsp; 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"#define REALTYPE8 float8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>&nbsp;&nbsp;&nbsp;&nbsp; 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"inline REALTYPE dot8( REALTYPE8 a, REALTYPE8 b )&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;REALTYPE8&nbsp;&nbsp;c = a * b;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;REALTYPE4&nbsp;&nbsp;_1 = ( REALTYPE4 ) 1.;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;return( dot( c.lo + c.hi, _1 ) );&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>&nbsp;&nbsp;&nbsp;&nbsp; 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"__kernel void matricesMul( __global REALTYPE *in1,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __global REALTYPE *in2,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; __global REALTYPE *out&nbsp;&nbsp;)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;int r = get_global_id( 0 );&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;REALTYPE8 rowbuf[ COLSROWS / 8 ];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;for( int col = 0; col &lt; COLSROWS / 8; col ++ )&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp; rowbuf[ col ] =&nbsp;&nbsp;( REALTYPE8 ) ( in1[r * COLSROWS + 8 * col ],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in1[r * COLSROWS + 8 * col + 1 ],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in1[r * COLSROWS + 8 * col + 2 ],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in1[r * COLSROWS + 8 * col + 3 ],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in1[r * COLSROWS + 8 * col + 4 ],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in1[r * COLSROWS + 8 * col + 5 ],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in1[r * COLSROWS + 8 * col + 6 ],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in1[r * COLSROWS + 8 * col + 7 ] );&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>&nbsp;&nbsp;&nbsp;&nbsp; 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;REALTYPE sum;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>&nbsp;&nbsp;&nbsp;&nbsp; 
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;for( int c = 0; c &lt; COLS2; c ++ )&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp; sum = 0.0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp; for( int cr = 0; cr &lt; COLSROWS / 8; cr ++ )&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sum += dot8(&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rowbuf[ cr ],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;( REALTYPE8 ) ( in2[c * COLSROWS + 8 * cr&nbsp;&nbsp;&nbsp;&nbsp; ],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in2[c * COLSROWS + 8 * cr + 1 ],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in2[c * COLSROWS + 8 * cr + 2 ],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in2[c * COLSROWS + 8 * cr + 3 ],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in2[c * COLSROWS + 8 * cr + 4 ],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in2[c * COLSROWS + 8 * cr + 5 ],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in2[c * COLSROWS + 8 * cr + 6 ],&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in2[c * COLSROWS + 8 * cr + 7 ] ) );&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;&nbsp;&nbsp; out[ r * COLS2 + c ] = sum;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; \r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span class="string">"}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\r\n"</span> ;</pre><p style="text-align:center;"><span class="small">Listado 10. Vectorización del kernel usando un vector de ancho 8.</span></p><p>Tuvimos que insertar en el código del kernel la función en línea dot8() que permite calcular el producto escalar de vectores de ancho 8. En OpenCL, la función estándar dot() puede calcular el producto escalar solo para vectores hasta de ancho 4. El código fuente puede consultarse en matr_mul_vect_v3.mq5.<br></p>CPU:<br><pre class="code"><span class="number">2012.05</span>.<span class="number">27</span> <span class="number">23</span>:<span class="number">11</span>:<span class="number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect_v3 (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime / GPUTotalTime = <span class="number">45.226</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">23</span>:<span class="number">11</span>:<span class="number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect_v3 (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;OpenCL total: time = <span class="number">2.200</span> sec.
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">23</span>:<span class="number">11</span>:<span class="number">47</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect_v3 (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;read = <span class="number">4000000</span> elements
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">23</span>:<span class="number">11</span>:<span class="number">45</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect_v3 (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime = <span class="number">99.497</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">23</span>:<span class="number">10</span>:<span class="number">05</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect_v3 (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;<span class="number">1</span>st OCL martices mul:&nbsp;&nbsp;device = <span class="number">0</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROWS1 = <span class="number">2000</span>; COLSROWS = <span class="number">2000</span>; COLS2 = <span class="number">2000</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">23</span>:<span class="number">10</span>:<span class="number">05</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect_v3 (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;=======================================</pre>GPU:<br><pre class="code"><span class="number">2012.05</span>.<span class="number">27</span> <span class="number">23</span>:<span class="number">20</span>:<span class="number">05</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect_v3 (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime / GPUTotalTime = <span class="number">170.115</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">23</span>:<span class="number">20</span>:<span class="number">05</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect_v3 (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;OpenCL total: time = <span class="number">0.546</span> sec.
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">23</span>:<span class="number">20</span>:<span class="number">05</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect_v3 (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;read = <span class="number">4000000</span> elements
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">23</span>:<span class="number">20</span>:<span class="number">04</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect_v3 (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;CPUTime = <span class="number">92.883</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">23</span>:<span class="number">18</span>:<span class="number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect_v3 (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;<span class="number">1</span>st OCL martices mul:&nbsp;&nbsp;device = <span class="number">1</span>;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ROWS1 = <span class="number">2000</span>; COLSROWS = <span class="number">2000</span>; COLS2 = <span class="number">2000</span>
<span class="number">2012.05</span>.<span class="number">27</span> <span class="number">23</span>:<span class="number">18</span>:<span class="number">31</span>&nbsp;&nbsp;&nbsp;&nbsp;matr_mul_vect_v3 (EURUSD,H1)&nbsp;&nbsp;&nbsp;&nbsp;=======================================</pre>

<p>Los resultados son inesperados: el tiempo de ejecución en la CPU es casi dos veces inferior que antes, donde se ha incrementado ligeramente para la GPU, a pesar del hecho de que float8 es un ancho de bus adecuado para la HD 4870 (siendo igual a 256 bits). Y aquí recurrimos de nuevo a GPU Caps Viewer. <br></p>
<p>La explicación puede encontrarse en la Fig. 18 en la penúltima línea de la lista del parámetro: <br></p>

<div class="code"><p>CL_DEVICE_PREFERRED_VECTOR_WIDTH_FLOAT: 4</p></div>

<p><br>Consulte la especificación de OpenCL y verá el siguiente texto sobre este parámetro en la última columna de la Tabla 4.3 en la página 37:</p><div class="fquote">

<p>Se prefiere un ancho de vector nativo para tipos de escalar integrados que puedan ponerse en los vectores. El ancho del vector se define como el número de elementos escalares que pueden almacenarse en el vector.<br>
</p>
</div><p>Por tanto, para la HD 4870 el ancho de vector preferido del vector floatN es float4 en lugar de float8.</p>
<p>Vamos a acabar con el ciclo de optimización del kernel aquí. Podríamos seguir hasta alcanzar mucho más pero la longitud de este artículo no permite dicha profundidad en el análisis.<br></p><br>

<h3>Conclusión<br></h3>

<p>Este artículo se centra en algunas capacidades de optimización que surgen cuando se tiene en cuenta el hardware subyacente en el que se ejecuta el kernel.</p>

<p> Las cifras obtenidas están lejos de ser un límite pero aún así sugieren que al tener disponibles los recursos existentes aquí y ahora (la API de OpenCL como se implementó por los desarrolladores del terminal no permite el control de algunos parámetros importantes para la optimización, particularmente el tamaño del grupo) la ganancia de rendimiento sobre la ejecución del programa anfitrión es muy sustancial: la ganancia en ejecución en la GPU sobre el programa secuencial en la CPU (aunque no muy optimizado) es de cerca del 200:1.&nbsp; <br></p>

<p>Mi sincero agradecimiento a MetaDriver por los valiosos consejos y la oportunidad de usar esta GPU discreta cuando la mía no estaba disponible.</p>
<p><br></p>
<p><b>Contenido de los archivos adjuntos:</b></p>
<ol>
<li><span style="color:rgb(0, 87, 174);">matr_mul_2dim.mq5</span> - el programa secuencial inicial en la representación de datos en dos dimensiones del anfitrión;</li><li><span style="color:rgb(0, 87, 174);">matr_mul_1dim.mq5</span> - la primera implementación del kernel con representación de datos lineal y una relevante validación de la API OpenCL de MQL5;</li>
<li><span style="color:rgb(0, 87, 174);">matr_mul_1dim_coalesced</span> - el kernel con acceso a memoria global combinado;</li>
<li><span style="color:rgb(0, 87, 174);">matr_mul_sum_local</span> - una variable privada introducida para el cálculo de un producto escalar, en lugar de acceder a una celda calculada de la matriz de salida almacenada en la memoria global;<br></li>
<li><span style="color:rgb(0, 87, 174);">matr_mul_row_calc</span> - el cálculo de toda la fila de la matriz de salida en el kernel;</li>
<li><span style="color:rgb(0, 87, 174);">matr_mul_row_in_private</span> - la fila de la primera matriz transferida a la memoria privada;</li>
<li><span style="color:rgb(0, 87, 174);">matr_mul_col_local.mq5</span> -la columna de la segunda matriz transferida a la memoria local;</li>
<li><span style="color:rgb(0, 87, 174);">matr_mul_vect.mq5</span> - la primera vectorización del kernel (usando float4, solo el sublazo interior del lazo principal);</li>
<li><span style="color:rgb(0, 87, 174);">matr_mul_vect_v2.mq5</span> - deshaciéndonos de las operaciones costosas de la conversión de datos en el lazo principal;</li><li><span style="color:rgb(0, 87, 174);">matr_mul_vect_v3.mq5</span> - Vectorización del kernel usando un vector de ancho 8.</li>
</ol>
<p><br></p>
</div>

    <p style="text-align: right;"><small>Traducción del ruso hecha por MetaQuotes Software Corp. <br>Artículo original: <a href="https://www.mql5.com/ru/articles/407" target="_blank">https://www.mql5.com/ru/articles/407</a></small></p>
    
        <div id="cb_407" class="attachBlock">
            <strong>Archivos adjuntos</strong> |
            <div class="grouped-attachments-help">
                <a class="zip" title="Descargar todos los anexos a un archivo único ZIP" href="https://www.mql5.com/es/articles/download/407">Descargar ZIP</a>
            </div> 
            <div class="attachItem">
                <a title="Descargar opencl_optimization_mql5.zip" class="zip" href="https://www.mql5.com/es/articles/download/407/opencl_optimization_mql5.zip">opencl_optimization_mql5.zip</a>
                <span class="attachSize">(35 KB)</span>
            </div>
        </div>
</div>
    
<div class="copyright">
<span style="color:#f00;font-weight:bold;">Advertencia:</span> todos los derechos de estos materiales pertenecen a MQL5 Ltd. Queda totalmente prohibido el copiado total o parcial.
</div>


</div>
<div class="relap-container"><script id="Jdolzg7OMYR-ogAA">if (window.relap) window.relap.ar('Jdolzg7OMYR-ogAA');</script></div>
   <div class="article__last-comments">
   
<div class="comments-preview">
  
      <div class="title"><span></span><b><a href="https://www.mql5.com/es/forum/22048">Pasar a la discusión en el foro de los operadores</a></b>
      </div>
        <div> 
        </div>
</div>
     </div>       

<div>
<div class="article-navigator">
  <div class="right">
   
    <div class="block">
      <img alt="OpenCL: El puente hacia mundos paralelos" src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/OpenCL_Logo.png" class="icon">
      <a href="https://www.mql5.com/es/articles/405" class="title">OpenCL: El puente hacia mundos paralelos</a>
      <p>A finales de enero de 2012 la empresa de desarrollo de software que está detrás de Meta Trader 5 anunció el soporte nativo de OpenCL en MQL5. Utilizando un ejemplo ilustrativo, el artículo plantea los fundamentos de programación en OpenCL en el entorno MQL5 y proporciona algunos ejemplos de la optimización simple del programa para incrementar la velocidad de operación.</p>
    </div>
    <div class="block">
      <img alt="Por qué es el mercado de MQL5 el mejor lugar para vender estrategias de trading e indicadores técnicos" src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/mql5-market.png" class="icon">
      <a href="https://www.mql5.com/es/articles/401" class="title">Por qué es el mercado de MQL5 el mejor lugar para vender estrategias de trading e indicadores técnicos</a>
      <p>El mercado de la comunidad MQL5 proporciona programadores de Expert Advisors con el mercado ya formado que comprenden miles de potenciales clientes. ¡Este es el mejor lugar para vender estrategias de trading e indicadores técnicos!</p>
    </div>  
  </div>
  <div class="left">
    
     <div class="block">
       <img alt="Programación basada en autómatas como nuevo enfoque en la creación de sistemas de trading automatizados" src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/11__3.png" class="icon">
       <a href="https://www.mql5.com/es/articles/446" class="title">Programación basada en autómatas como nuevo enfoque en la creación de sistemas de trading automatizados</a>
       <p>Este artículo nos lleva en una nueva dirección a la hora de desarrollar Asesores Expertos, indicadores y scripts en MQL4 y MQL5. En el futuro, este modelo de programación se convertirá en un estándar para todos los operadores en la implementación de Asesores Expertos. Utilizando el modelo de programación basado en autómatas, los desarrolladores de MQL5 y Meta Trader 5 estarán cerca de poder crear un nuevo lenguaje, MQL6, y una nueva plataforma, Meta Trader 6.</p>
     </div>
     <div class="block">
       <img alt="Los miembros más activos de la comunidad MQL5 ¡han sido premiados con iPhones!" src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/win_iPhone.png" class="icon">
       <a href="https://www.mql5.com/es/articles/451" class="title">Los miembros más activos de la comunidad MQL5 ¡han sido premiados con iPhones!</a>
       <p>Después de que decidiéramos premiar a los participantes más destacados de MQL5.com, hemos seleccionado el criterio clave para determinar la contribución de cada participante al desarrollo de la Comunidad. Como resultado, tenemos los siguientes campeones que publicaron la mayor cantidad de artículos en la website - investeo (11 artículos) y victorg (10 artículos) y quien envió sus programas a la Base de Código - GODZILLA (340 programas), Integer (61 programas) y abolk (21 programas).</p>
     </div>  
  </div>
</div>
</div>
<div class="clear-fix"></div>
</div>

    </div>

    <div class="footer desktop">
        <ul class="links">
            <li id="navFooterCommunity">
                <b>MQL5.community</b>
                <ul>
                    <li><a href="https://www.mql5.com/es/trading">Trading online / Terminal web</a></li>
                    <li><a href="https://www.mql5.com/es/code">Indicadores y asesores gratuitos</a></li>
                    <li><a href="https://www.mql5.com/es/articles">Artículos sobre programación y trading</a></li>
                    <li><a href="https://www.mql5.com/es/job">Encargar un asesor experto o indicador</a></li>
                    <li><a href="https://www.mql5.com/es/market">Comprar un robot comercial o indicador</a></li>
                    <li><a href="https://www.mql5.com/es/signals">Señales comerciales fórex</a></li>
                    <li><a href="https://www.mql5.com/es/vps">Forex VPS para comerciar</a></li>
                    <li><a href="https://www.mql5.com/es/forum">Foro de tráders</a></li>
                    <li><a href="https://www.mql5.com/es/blogs">Blogs de tráders</a></li>
                    <li><a href="https://www.mql5.com/es/charts">Gráfico</a></li>
                </ul>
            </li><!--

         --><li id="navFooterMt5">
                <b>MetaTrader 5</b>
                <ul>
                    <li><a href="https://www.metatrader5.com/">Plataforma comercial MetaTrader 5</a></li>
                    <li><a href="https://www.metatrader5.com/es/terminal/help">Guía del usuario de MetaTrader 5</a></li>
                    <li><a href="https://www.mql5.com/es/docs">Lenguaje de estrategias MQL5</a></li>
                    <li><a href="https://cloud.mql5.com/">MQL5 Cloud Network</a></li>
                    <li><a href="https://download.mql5.com/cdn/web/metaquotes.software.corp/mt5/mt5setup.exe?utm_campaign=MQL5.community">Descargar MetaTrader 5</a></li>
                    <li><a href="https://www.metatrader5.com/es/terminal/help/start_advanced/installation">Instalar la plataforma</a></li>
                    <li><a href="https://www.metatrader5.com/es/terminal/help/start_advanced/deinstallation">Eliminar programas</a></li>
                </ul>
             
                
            </li><!--

         --><li id="navFooterWebsite">
             
                
                <b>Información sobre la página</b>
                <ul>
                    <li><a href="https://www.mql5.com/es/about">Sobre el proyecto</a></li><li><a href="https://www.mql5.com/es/wall">Crónica de la página</a></li><li><a href="https://www.mql5.com/es/about/terms">Condiciones de uso</a></li>
                    <li><a href="https://www.mql5.com/es/about/privacy">Política de privacidad</a></li>
                    <li><a href="https://www.mql5.com/es/contact">Información y contacto</a></li>
                    
                </ul>

                
            </li><!--

         --><li id="navFooterDownload">
                <b>¡Únete, descarga <span class="nobr">MetaTrader 5!</span></b>
                <ul>
                    <li class="icon windows"><a href="https://download.mql5.com/cdn/web/metaquotes.software.corp/mt5/mt5setup.exe?utm_campaign=MQL5.community" onclick="window.fpush(&#39;Download+MT5+Windows&#39;);" title="¡Descargar MetaTrader 5 para Windows gratis!">Windows</a></li><li class="icon ios"><a href="https://download.mql5.com/cdn/mobile/mt5/ios?hl=es&amp;utm_campaign=MQL5.community" target="_blank" rel="nofollow" onclick="window.fpush(&#39;Download+MT5+iOS&#39;);" title="¡Descargar MetaTrader 5 para iPhone gratis!">iPhone/iPad</a></li><li class="icon macos"><a href="https://www.mql5.com/es/articles/619" target="_blank" title="Cómo instalar MetaTrader 5 en Mac OS">Mac OS</a></li><li class="icon android"><a href="https://download.mql5.com/cdn/mobile/mt5/android?hl=es&amp;utm_campaign=MQL5.community" target="_blank" rel="nofollow" onclick="window.fpush(&#39;Download+MT5+Android&#39;);" title="¡Descargar MetaTrader 5 Android en Google Play gratis!"><span>Android</span></a></li><li class="icon linux"><a href="https://www.mql5.com/es/articles/625" target="_blank" title="MetaTrader 5 para Linux"><span>Linux</span></a></li>
                </ul>
                
                <div class="copyright">Copyright 2000-2017, <span class="nobr">MQL5 Ltd.</span></div>
            </li>

        </ul>


    </div>
</div>

<script src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/all.1fa150b1e8e8244bd5bd16bb18b62c9b.js.descarga" type="text/javascript"></script>
<script src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/articles.fef6e4dc1f10c5a8fd6765060b99c671.js.descarga" type="text/javascript"></script>

<script type="text/javascript">
  window.globalStorageDomain = "https://c.mql5.com";
  mqGlobal.AddOnLoad(function(){Mql5Cookie.init('mql5.com','59514465-13CA',null);});
  
  if(typeof Attach !== "undefined")
    Attach.setAcceptFilter(".gif,.png,.jpg,.jpeg,.zip,.txt,.log,.mqh,.ex5,.mq5,.mq4,.ex4,.mt5,.set,.tpl");
</script>
<script type="text/javascript">
    (function (i, s, o, g, r) { i[r] = i[r] || function () { (i[r].q = i[r].q || []).push(arguments); }; i[r].l = 1 * new Date(); var a = s.createElement(o); a.async = true; a.src = g; var m = s.getElementsByTagName(o)[0]; m.parentNode.insertBefore(a, m); })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga'); ga('create', 'UA-468814-5', 'mql5.com'); ga('send', 'pageview');
</script>



<!-- Generated in 21266.5997 ms --><img width="0" height="0" src="./OpenCL_ De una programación simple a una más intuitiva - Artículos sobre MQL5_files/lead" style="display: none;"></body></html>